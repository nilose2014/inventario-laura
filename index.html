<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Laura Online</title>
<style>
body{font-family:Arial;background:#f0f2f5;padding:20px;max-width:1200px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:10px;text-align:center}
th{background:#007bff;color:white}
button{padding:8px 12px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:14px;margin:2px;font-weight:bold}
button:hover{background:#0056b3}
.red{background:#dc3545}
.red:hover{background:#c82333}
.sin-stock{background:#ffe5e5 !important}
input{padding:8px;border-radius:5px;border:1px solid #ccc;width:120px;display:block;margin:5px 0;font-size:14px}
#buscar{width:250px;padding:10px;font-size:16px}
#status{padding:15px;margin-bottom:20px;border-radius:8px;text-align:center;font-weight:bold;font-size:16px}
.working{background:#d4edda;color:#155724;border:2px solid #c3e6cb}
.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb}
h2{text-align:center;color:#333}
.totales{text-align:center;font-size:18px;font-weight:bold}
</style>
</head>
<body>

<h2>ğŸ›’ Inventario Laura Online</h2>

<div id="status" class="error">ğŸ”„ Conectando con Firebase...</div>

<div class="card">
<strong>ğŸ“¦ Nuevo/Editar Producto:</strong><br><br>
Producto <input id="nombre" placeholder="Nombre del producto"><br>
Stock <input id="stock" type="number" placeholder="0"><br>
Precio Bea <input id="bea" type="number" step="0.01" placeholder="0.00"><br>
Precio Laura <input id="laura" type="number" step="0.01" placeholder="0.00"><br><br>
<button onclick="guardar()">ğŸ’¾ Guardar Nuevo</button>
<button class="red" onclick="cancelarEdit()" id="cancelBtn" style="display:none">âŒ Cancelar</button>
</div>

<div class="card">
ğŸ” <input placeholder="Buscar producto..." id="buscar" onkeyup="render()"><br><br>
<table>
<thead>
<tr>
<th>Producto</th><th>Stock</th><th>Bea â‚¬</th><th>Laura â‚¬</th><th>Vender</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<div class="card totales">
ğŸ’° <strong>Totales:</strong><br>
Venta Bea: â‚¬<span id="tBea">0.00</span> | Venta Laura: â‚¬<span id="tLaura">0.00</span><br><br>
<button class="red" onclick="resetear()">ğŸ”„ Resetear TODAS las ventas</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productosRef = ref(db, "productos");

let productos = {};
let editId = null;

// âœ… CONEXIÃ“N AUTOMÃTICA
onValue(productosRef, (snap) => {
  productos = snap.val() || {};
  document.getElementById('status').textContent = `âœ… Conectado - ${Object.keys(productos).length} productos`;
  document.getElementById('status').className = 'working';
  render();
}, (error) => {
  console.error('Error:', error);
  document.getElementById('status').textContent = 'âŒ Error: ' + error.message;
  document.getElementById('status').className = 'error';
});

window.guardar = () => {
  const nombre = document.getElementById('nombre').value.trim();
  if(!nombre) return alert('âŒ Escribe el nombre del producto');
  
  const data = {
    nombre,
    stock: Math.max(0, Number(document.getElementById('stock').value) || 0),
    bea: Math.max(0, Number(document.getElementById('bea').value) || 0),
    laura: Math.max(0, Number(document.getElementById('laura').value) || 0),
    vBea: editId ? (productos[editId]?.vBea || 0) : 0,
    vLaura: editId ? (productos[editId]?.vLaura || 0) : 0
  };

  if(editId) {
    update(ref(db, 'productos/' + editId), data)
      .then(() => { 
        limpiarFormulario(); 
        alert('âœ… Producto actualizado'); 
      })
      .catch(e => alert('âŒ Error: ' + e.message));
  } else {
    push(productosRef, data)
      .then(() => { 
        limpiarFormulario(); 
        alert('âœ… Producto guardado'); 
      })
      .catch(e => alert('âŒ Error: ' + e.message));
  }
};

window.vender = (id, cant) => {
  const p = productos[id];
  cant = Number(cant);
  if(cant <= 0 || (p.stock || 0) < cant) return alert('âŒ Stock insuficiente');
  
  update(ref(db, 'productos/' + id), {
    stock: (p.stock || 0) - cant,
    vBea: (p.vBea || 0) + (p.bea || 0) * cant,
    vLaura: (p.vLaura || 0) + (p.laura || 0) * cant
  }).then(() => alert(`âœ… Vendido ${cant} unidades`));
};

window.editar = (id) => {
  const p = productos[id];
  document.getElementById('nombre').value = p.nombre || '';
  document.getElementById('stock').value = p.stock || 0;
  document.getElementById('bea').value = p.bea || 0;
  document.getElementById('laura').value = p.laura || 0;
  editId = id;
  document.getElementById('cancelBtn').style.display = 'inline-block';
};

window.borrar = (id) => {
  if(confirm(`ğŸ—‘ï¸ Borrar "${productos[id]?.nombre || 'Producto'}"?`)) {
    remove(ref(db, 'productos/' + id))
      .then(() => alert('âœ… Borrado'))
      .catch(e => alert('âŒ Error: ' + e.message));
  }
};

window.cancelarEdit = () => limpiarFormulario();

window.resetear = () => {
  if(confirm('ğŸ”„ Â¿Resetear TODAS las ventas a 0?')) {
    const updates = {};
    Object.entries(productos).forEach(([id]) => {
      updates[`productos/${id}/vBea`] = 0;
      updates[`productos/${id}/vLaura`] = 0;
    });
    update(ref(db), updates).then(() => alert('âœ… Ventas reseteadas'));
  }
};

function limpiarFormulario() {
  document.getElementById('nombre').value = 
  document.getElementById('stock').value = 
  document.getElementById('bea').value = 
  document.getElementById('laura').value = '';
  editId = null;
  document.getElementById('cancelBtn').style.display = 'none';
}

window.render = () => {
  const filtro = document.getElementById('buscar').value.toLowerCase();
  let totalBea = 0, totalLaura = 0;
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = '';

  Object.entries(productos).forEach(([id, p]) => {
    if(!p?.nombre?.toLowerCase().includes(filtro)) return;
    
    totalBea += Number(p.vBea || 0);
    totalLaura += Number(p.vLaura || 0);
    
    tabla.innerHTML += `
    <tr class="${(p.stock || 0) <= 0 ? 'sin-stock' : ''}">
      <td style="font-weight:bold">${p.nombre}</td>
      <td>${p.stock || 0}</td>
      <td>${Number(p.bea || 0).toFixed(2)}</td>
      <td>${Number(p.laura || 0).toFixed(2)}</td>
      <td>
        <input type="number" min="1" max="${p.stock || 0}" value="1" style="width:60px">
        <button onclick="vender('${id}',this.previousElementSibling.value)">ğŸ›’</button>
      </td>
      <td>
        <button onclick="editar('${id}')">âœï¸</button>
        <button class="red" onclick="borrar('${id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  });

  document.getElementById('tBea').textContent = totalBea.toFixed(2);
  document.getElementById('tLaura').textContent = totalLaura.toFixed(2);
};

// Render inicial
setTimeout(render, 500);
</script>

</body>
</html>



