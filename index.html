<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Laura Online - ORDENABLE + BACKUP</title>
<style>
body{font-family:Arial;background:#f0f2f5;padding:20px;max-width:1400px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px}
th{background:#007bff;color:white}
button{padding:6px 10px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:12px;margin:1px;font-weight:bold}
button:hover{background:#0056b3}
.red{background:#dc3545}
.red:hover{background:#c82333}
.sin-stock{background:#ffe5e5 !important}
.stock-bajo{background:#fff3cd !important}
.reservado{background:#e8f4fd !important}
.reservado-bajo{background:#d1ecf1 !important}
input{padding:6px;border-radius:5px;border:1px solid #ccc;width:60px;font-size:12px}
#nombre{width:300px !important;font-size:16px;padding:10px !important}
#stock{width:80px;font-size:16px;padding:8px !important;text-align:center}
#buscar{width:200px;padding:8px;font-size:14px;position:relative}
#buscar-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#dc3545;color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:none;font-weight:bold;line-height:18px}
#buscar-clear:hover{background:#c82333}
#ordenar{width:200px;padding:8px;font-size:14px}
#status{padding:15px;margin-bottom:20px;border-radius:8px;text-align:center;font-weight:bold;font-size:16px}
.admin{background:#d4edda;color:#155724;border:2px solid #c3e6cb}
.user{background:#d1ecf1;color:#0c5460;border:2px solid #bee5eb}
.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb}
.login-card{background:#fff3cd;border:2px solid #ffeaa7}
.hidden{display:none}
.disabled{background:#ccc !important;cursor:not-allowed !important}
.diferencia-positiva{background:#d4edda !important;color:#155724;font-weight:bold}
.diferencia-negativa{background:#f8d7da !important;color:#721c24;font-weight:bold}
.contadores-filtrados {background: #e9ecef;padding: 8px 12px;border-radius: 5px;font-weight: bold;font-size: 14px;margin-left: 15px;min-width: 120px;}
#productosVisibles { color: #007bff; }
#stockVisible { color: #28a745; }
.totales-superiores {display: grid;grid-template-columns: 1fr 1fr 1fr 1fr 1fr;gap: 15px;text-align: center;font-size: 20px;font-weight: bold;padding: 20px;margin-bottom: 20px;background: white;border-radius: 10px;box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
.total-box-superior {padding: 15px;border-radius: 10px;border: 2px solid #ddd;transition: all 0.3s ease;}
.total-box-superior:hover { transform: scale(1.02); }
.total-box-superior.bea { background: #d4edda; border-color: #28a745; }
.total-box-superior.laura { background: #cce7ff; border-color: #007bff; }
.total-box-superior.diferencia { border-color: #ffc107; }
.total-box-superior.reservados { background: #e8f4fd; border-color: #17a2b8; }
.total-box-superior.vendidos { background: #d1ecf1; border-color: #28a745; }
.totales-container {display: grid;grid-template-columns: 1fr 1fr 1fr 1fr 1fr;gap: 15px;text-align: center;font-size: 18px;font-weight: bold;padding: 20px;}
.total-box{padding:12px;border-radius:10px}
.editable{background:#fff3cd !important}
.vendidos{font-weight:bold;color:#28a745}
.reservados{font-weight:bold;color:#17a2b8}
.filtros{display:flex;gap:15px;align-items:center;margin-bottom:15px;flex-wrap:wrap}
select{background:#fff;border:1px solid #ddd;border-radius:5px;padding:8px}
.stock-edit-btn{font-size:10px;padding:1px 4px;margin-left:3px}
.stock-editable{background:#fff3cd !important}
.undo-btn{background:#ffc107 !important;color:#000 !important;font-size:11px;padding:2px 5px !important;margin-left:2px}
.undo-btn:hover{background:#e0a800 !important}
#scrollTopBtn{position:fixed;bottom:30px;right:30px;background:#007bff;color:white;border:none;border-radius:50%;width:60px;height:60px;font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(0,123,255,0.4);display:none;z-index:1000;transition:all 0.3s ease}
#scrollTopBtn:hover{background:#0056b3;transform:scale(1.1)}
#scrollTopBtn.show{display:block}
.reservar-btn{background:#17a2b8 !important}
.reservar-btn:hover{background:#138496 !important}
.confirmar-btn{background:#28a745 !important}
.confirmar-btn:hover{background:#218838 !important}
.cancelar-reserva{background:#ffc107 !important;color:#000 !important}
.cancelar-reserva:hover{background:#e0a800 !important}
.backup-btn{background:#28a745 !important;color:white !important;font-weight:bold !important;padding:10px 15px !important;font-size:14px !important}
.backup-btn:hover{background:#218838 !important}
.restore-btn{background:#17a2b8 !important;color:white !important;font-weight:bold !important;padding:10px 15px !important;font-size:14px !important}
.restore-btn:hover{background:#138496 !important}
#backupArea{background:#f8f9fa;border:2px dashed #007bff;padding:20px;border-radius:10px;margin:10px 0;text-align:center;min-height:100px}
#backupText{font-family:monospace;background:#e9ecef;padding:15px;border-radius:5px;max-height:300px;overflow:auto;white-space:pre-wrap;font-size:12px}
.download-link{display:inline-block;background:#28a745;color:white;padding:8px 15px;border-radius:5px;text-decoration:none;margin-top:10px;font-weight:bold}
.download-link:hover{background:#218838}
</style>
</head>
<body>

<h2>ğŸ›’ Inventario Laura Online - ORDENABLE + ğŸ”„ BACKUP</h2>

<!-- LOGIN OBLIGATORIO -->
<div class="card login-card" id="loginDiv">
  <h3>ğŸ” Iniciar SesiÃ³n</h3>
  <input id="userEmail" type="email" placeholder="Email" list="userList"><br>
  <input id="userPass" type="password" placeholder="ContraseÃ±a"><br><br>
  
  <datalist id="userList">
    <option value="nilose2014@gmail.com">ğŸ‘‘ ADMIN</option>
    <option value="djsubixj@gmail.com">ğŸ‘¤ Usuario</option>
    <option value="xiomaralamasmala@gmail.com">ğŸ‘¤ Usuario</option>
  </datalist>
  
  <button onclick="login()">ğŸš€ Entrar</button>
  <button class="red" onclick="resetLogin()">ğŸ”„ Limpiar</button>
</div>

<div id="mainApp" style="display:none">

<!-- ğŸ¯ TOTALES SUPERIORES - VISIBLES SIEMPRE -->
<div class="totales-superiores">
  <div class="total-box-superior bea">
    <strong>ğŸ’° Venta Bea</strong><br>
    <span id="tBeaSup" style="font-size:28px">â‚¬0.00</span>
  </div>
  <div class="total-box-superior laura">
    <strong>ğŸ’° Venta Laura</strong><br>
    <span id="tLauraSup" style="font-size:28px">â‚¬0.00</span>
  </div>
  <div class="total-box-superior diferencia" id="diferenciaBoxSup">
    <strong>ğŸ“Š Diferencia (L-B)</strong><br>
    <span id="tDiferenciaSup" style="font-size:28px">â‚¬0.00</span>
  </div>
  <div class="total-box-superior reservados">
    <strong>ğŸ“¦ Reservados</strong><br>
    <span id="tTotalReservadosSup" style="font-size:28px">0</span>
  </div>
  <div class="total-box-superior vendidos">
    <strong>ğŸ“¦ Total Vendidos</strong><br>
    <span id="tTotalVendidosSup" style="font-size:28px">0</span>
  </div>
</div>

<div id="status" class="error">Cargando...</div>

<!-- SECCIÃ“N NUEVO/EDITAR - SOLO ADMIN -->
<div class="card" id="nuevoProductoDiv">
<strong>ğŸ“¦ Nuevo/Editar Producto:</strong><br><br>
Producto <input id="nombre" placeholder="Nombre del producto" maxlength="100"><br>
Stock <input id="stock" type="number" placeholder="0"><br>
Precio Bea <input id="bea" type="number" step="0.01" placeholder="0.00"><br>
Precio Laura <input id="laura" type="number" step="0.01" placeholder="0.00"><br><br>
<button onclick="guardar()" id="guardarBtn">ğŸ’¾ Guardar Nuevo</button>
<button class="red" onclick="cancelarEdit()" id="cancelBtn" style="display:none">âŒ Cancelar</button>
</div>

<div class="card">
<div class="filtros">
ğŸ” <div style="position:relative;display:inline-block">
  <input placeholder="Buscar producto..." id="buscar" onkeyup="toggleClearBtn();renderTablaSolo()">
  <button id="buscar-clear" onclick="clearSearch()" title="Limpiar bÃºsqueda">âœ•</button>
</div>
<div class="contadores-filtrados">
  <div id="productosVisibles">ğŸ“¦ 0 productos</div>
  <div id="stockVisible">ğŸ“Š Stock: 0</div>
</div>
ğŸ†š Ordenar: 
<select id="ordenar" onchange="renderTablaSolo()">
  <option value="nombre-asc">A â†’ Z</option>
  <option value="nombre-desc">Z â†’ A</option>
  <option value="stock-asc">Stock â†“</option>
  <option value="stock-desc">Stock â†‘</option>
  <option value="vendidos-desc">Vendidos â†“</option>
  <option value="vendidos-asc">Vendidos â†‘</option>
  <option value="reservados-desc">Reservados â†“</option>
  <option value="reservados-asc">Reservados â†‘</option>
  <option value="bea-asc">Bea â†“</option>
  <option value="bea-desc">Bea â†‘</option>
  <option value="laura-asc">Laura â†“</option>
  <option value="laura-desc">Laura â†‘</option>
</select>
</div><br>
<table>
<thead>
<tr>
<th>Producto</th><th>Stock</th><th>Reservados</th><th>Vendidos</th><th>Bea â‚¬</th><th>Laura â‚¬</th><th>Reservar</th><th>Vender</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- TOTALES INFERIORES -->
<div class="totales-container">
  <div class="total-box">
    <strong>ğŸ’° Venta Bea</strong><br>
    <span id="tBea" style="font-size:24px">â‚¬0.00</span>
  </div>
  <div class="total-box">
    <strong>ğŸ’° Venta Laura</strong><br>
    <span id="tLaura" style="font-size:24px">â‚¬0.00</span>
  </div>
  <div class="total-box" id="diferenciaBox">
    <strong>ğŸ“Š Diferencia (L-B)</strong><br>
    <span id="tDiferencia" style="font-size:24px">â‚¬0.00</span>
  </div>
  <div class="total-box reservados">
    <strong>ğŸ“¦ Reservados</strong><br>
    <span id="tTotalReservados" style="font-size:24px">0</span>
  </div>
  <div class="total-box vendidos">
    <strong>ğŸ“¦ Total Vendidos</strong><br>
    <span id="tTotalVendidos" style="font-size:24px">0</span>
  </div>
</div>

<div class="card" style="text-align:center">
<button class="red" onclick="resetear()" id="resetBtn" title="Resetea ventas, vendidos, reservados y totales">ğŸ”„ Reset COMPLETO</button>
<button onclick="modificarPrecioLauraGlobal()" id="precioGlobalBtn">ğŸ’² Precio Laura Global</button>
<button onclick="logout()" style="background:#28a745">ğŸ” Cambiar Usuario</button>
</div>

<!-- ğŸ¯ SECCIÃ“N BACKUP - SOLO nilose2014@gmail.com - ABAJO DEL TODO -->
<div class="card hidden" id="backupSection">
  <h3>ğŸ’¾ Sistema de Backup Completo</h3>
  <button class="backup-btn" onclick="hacerBackup()" style="margin-right:10px">ğŸ“¥ DESCARGAR BACKUP</button>
  <label for="backupFile" class="restore-btn" style="cursor:pointer;padding:10px 15px;border-radius:5px">ğŸ“¤ RESTAURAR BACKUP</label>
  <input type="file" id="backupFile" accept=".json" style="display:none" onchange="restaurarBackup(event)">
  
  <div id="backupArea">
    <p>ğŸ“‹ Ãšltimo backup disponible aquÃ­ ğŸ‘‡</p>
    <div id="backupText">Genera tu primer backup con el botÃ³n superior...</div>
    <div id="backupDate"></div>
  </div>
</div>

</div>

<button id="scrollTopBtn" title="Subir arriba">â¬†ï¸</button>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update, remove, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const productosRef = ref(db, "productos");

let productos = {};
let totalesGlobales = { bea: 0, laura: 0, vendidos: 0, reservados: 0 };
let editId = null;
let currentUser = null;
let userRole = null;

const EMAILJS_CONFIG = {
  service: 'service_65ryfan',
  template: 'template_06j67bo',
  publicKey: 'q6b-zVGH0aBXeREzv'
};

let ultimoBackup = null;
let backupRef = ref(db, 'backup/ultimo');
let productosVisiblesCount = 0;
let stockVisibleTotal = 0;

window.toggleClearBtn = () => {
  const buscar = document.getElementById('buscar');
  const clearBtn = document.getElementById('buscar-clear');
  if (buscar.value.length > 0) {
    clearBtn.style.display = 'block';
  } else {
    clearBtn.style.display = 'none';
  }
};

window.clearSearch = () => {
  const buscar = document.getElementById('buscar');
  buscar.value = '';
  document.getElementById('buscar-clear').style.display = 'none';
  renderTablaSolo();
};

window.actualizarContadoresFiltrados = (count, stockTotal) => {
  document.getElementById('productosVisibles').textContent = `ğŸ“¦ ${count} productos`;
  document.getElementById('stockVisible').textContent = `ğŸ“Š Stock: ${stockTotal}`;
};

window.renderTablaSolo = () => {
  const filtro = document.getElementById('buscar').value.toLowerCase();
  const productosOrdenados = ordenarProductos(productos);
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = '';

  productosVisiblesCount = 0;
  stockVisibleTotal = 0;

  productosOrdenados.forEach(([id,p]) => {
    if(!p?.nombre?.toLowerCase().includes(filtro)) return;
    
    productosVisiblesCount++;
    stockVisibleTotal += Number(p.stock || 0);
    
    const stockDisponible = (p.stock||0);
    const stockClass = stockDisponible<=0 ? 'sin-stock' : stockDisponible<=5 ? 'stock-bajo' : '';
    const stockCellClass = userRole === 'admin' ? 'stock-editable' : '';
    const filaClass = (p.reservados||0)>0 ? 'reservado' : stockClass;
    
    tabla.innerHTML += `
    <tr class="${filaClass}">
      <td style="font-weight:bold;text-align:left">${p.nombre}</td>
      <td class="${stockCellClass}">
        ${stockDisponible}
        ${userRole === 'admin' ? `<button class="stock-edit-btn" onclick="modificarStock('${id}')" title="Editar stock">ğŸ“¦</button>` : ''}
      </td>
      <td class="reservados">
        ${(p.reservados||0)}
        ${(p.reservados||0)>0 ? `<br><button class="cancelar-reserva" onclick="cancelarReserva('${id}',1)" title="Cancelar 1 reserva">âŒ</button>` : ''}
      </td>
      <td class="vendidos">${p.vendidos||0}
        ${userRole === 'admin' && (p.vendidos||0) > 0 ? `<button class="undo-btn" onclick="eliminarUnaVenta('${id}')" title="Eliminar 1 venta">â†©ï¸</button>` : ''}
      </td>
      <td>${Number(p.bea||0).toFixed(2)}</td>
      <td class="editable">
        <strong>${Number(p.laura||0).toFixed(2)}</strong>
        <button onclick="modificarPrecioLaura('${id}')" style="font-size:10px;padding:1px 4px;margin-left:3px">ğŸ’²</button>
      </td>
      <td>
        <input type="number" min="1" max="${stockDisponible}" value="1" style="width:50px">
        <button class="reservar-btn" onclick="reservar('${id}',this.previousElementSibling.value)">â³</button>
      </td>
      <td>
        <input type="number" min="1" max="${stockDisponible}" value="1" style="width:50px">
        <button onclick="vender('${id}',this.previousElementSibling.value)">ğŸ›’</button>
      </td>
      <td>
        <button onclick="editar('${id}')" ${userRole !== 'admin' ? 'class="disabled" disabled' : ''}>âœï¸</button>
        <button class="red" onclick="borrar('${id}')" ${userRole !== 'admin' ? 'class="disabled" disabled' : ''}>ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  });

  actualizarContadoresFiltrados(productosVisiblesCount, stockVisibleTotal);
};

window.hacerBackup = async () => {
  if(currentUser.email !== 'nilose2014@gmail.com') return alert('âŒ Solo nilose2014@gmail.com puede hacer backup');
  
  try {
    const backupData = {
      productos: productos,
      totalesGlobales: totalesGlobales,
      fecha: new Date().toISOString(),
      usuario: currentUser.email,
      timestamp: Date.now()
    };
    
    await set(backupRef, backupData);
    
    document.getElementById('backupText').textContent = JSON.stringify(backupData, null, 2);
    document.getElementById('backupDate').innerHTML = `<strong>ğŸ“… Backup creado: ${new Date().toLocaleString('es-ES')}</strong>`;
    
    const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-inventario-${new Date().toISOString().slice(0,10)}.json`;
    a.textContent = 'ğŸ’¾ DESCARGAR BACKUP';
    a.className = 'download-link';
    document.getElementById('backupArea').appendChild(a);
    
    const oldLink = document.querySelector('.download-link');
    if(oldLink && oldLink !== a) oldLink.remove();
    
    ultimoBackup = backupData;
    alert('âœ… Backup completado y descargado');
    
  } catch(error) {
    alert('âŒ Error en backup: ' + error.message);
  }
};

window.restaurarBackup = async (event) => {
  if(currentUser.email !== 'nilose2014@gmail.com') return alert('âŒ Solo nilose2014@gmail.com puede restaurar');
  
  const file = event.target.files[0];
  if(!file) return;
  
  if(!confirm('âš ï¸ Â¿Restaurar TODO desde este backup?\n\nâœ… Se reemplazan TODOS los productos\nâœ… Se actualizan todos los totales')) return;
  
  try {
    const text = await file.text();
    const backupData = JSON.parse(text);
    
    await set(ref(db, 'productos'), backupData.productos);
    
    alert('âœ… RestauraciÃ³n completada. Recarga la pÃ¡gina.');
    location.reload();
    
  } catch(error) {
    alert('âŒ Error restaurando: ' + error.message);
  }
};

window.cargarBackupFirebase = () => {
  if(currentUser.email !== 'nilose2014@gmail.com') return;
  onValue(backupRef, (snap) => {
    if(snap.exists()) {
      ultimoBackup = snap.val();
      document.getElementById('backupText').textContent = JSON.stringify(ultimoBackup, null, 2);
      const fecha = new Date(ultimoBackup.timestamp).toLocaleString('es-ES');
      document.getElementById('backupDate').innerHTML = `<strong>ğŸ“… Ãšltimo backup Firebase: ${fecha}</strong>`;
    }
  });
};

async function enviarEmail(datos) {
  if (!window.emailjs) return console.log('EmailJS cargando...');
  emailjs.init(EMAILJS_CONFIG.publicKey);
  try {
    await emailjs.send(EMAILJS_CONFIG.service, EMAILJS_CONFIG.template, datos);
    console.log('âœ… Email enviado:', datos.subject);
  } catch(err) {
    console.log('âŒ Error email:', err);
  }
}

window.onscroll = () => {
  const btn = document.getElementById('scrollTopBtn');
  if (window.scrollY > 300) btn.classList.add('show');
  else btn.classList.remove('show');
};

document.getElementById('scrollTopBtn').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    checkUserRole();
  } else {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginDiv').style.display = 'block';
  }
});

window.login = () => {
  const email = document.getElementById('userEmail').value.trim();
  const pass = document.getElementById('userPass').value;
  if(!email || !pass) return alert('âŒ Email y contraseÃ±a requeridos');
  signInWithEmailAndPassword(auth, email, pass).catch(e => alert('âŒ Error: ' + e.message));
};

window.logout = () => signOut(auth).catch(e => alert('âŒ Error: ' + e.message));

window.resetLogin = () => {
  document.getElementById('userEmail').value = '';
  document.getElementById('userPass').value = '';
};

function checkUserRole() {
  if(currentUser.email === 'nilose2014@gmail.com') {
    userRole = 'admin';
    // âœ… MOSTRAR BACKUP SOLO PARA nilose2014@gmail.com (ABAJO DEL TODO)
    document.getElementById('backupSection').classList.remove('hidden');
  } else if(['djsubixj@gmail.com', 'xiomaralamasmala@gmail.com'].includes(currentUser.email)) {
    userRole = 'user';
    // âŒ OCULTAR BACKUP para otros usuarios
    document.getElementById('backupSection').classList.add('hidden');
  } else {
    userRole = 'user';
    document.getElementById('backupSection').classList.add('hidden');
  }
  updateUI();
  toggleNuevoProducto();
  loadData();
  if(currentUser.email === 'nilose2014@gmail.com') cargarBackupFirebase();
}

function toggleNuevoProducto() {
  document.getElementById('nuevoProductoDiv').style.display = userRole === 'admin' ? 'block' : 'none';
}

function updateUI() {
  const status = document.getElementById('status');
  const guardarBtn = document.getElementById('guardarBtn');
  const resetBtn = document.getElementById('resetBtn');
  const precioGlobalBtn = document.getElementById('precioGlobalBtn');
  
  if(userRole === 'admin') {
    status.innerHTML = `ğŸ‘‘ <strong>ADMIN (nilose2014@gmail.com):</strong> ${currentUser.email}<br>Todos los permisos + BACKUP âœ…`;
    status.className = 'admin';
    guardarBtn.disabled = false; guardarBtn.className = '';
    resetBtn.disabled = false; resetBtn.className = '';
    precioGlobalBtn.disabled = false;
  } else {
    status.innerHTML = `ğŸ‘¤ <strong>USUARIO:</strong> ${currentUser.email}<br>Solo ventas + precio Laura âœ…`;
    status.className = 'user';
    guardarBtn.disabled = true; guardarBtn.className = 'disabled';
    resetBtn.disabled = true; resetBtn.className = 'disabled';
    precioGlobalBtn.disabled = false; precioGlobalBtn.className = '';
  }
}

function loadData() {
  console.log('ğŸ” === DEBUG LOAD DATA INICIADO ===');
  console.log('ğŸ‘¤ Usuario actual:', currentUser?.email);
  console.log('ğŸ­ Rol detectado:', userRole);
  console.log('ğŸŒ URL Database:', productosRef.toString());
  console.log('ğŸ”— Reglas esperadas: auth != null');
  
  onValue(productosRef, (snap) => {
    console.log('âœ… SNAPSHOT RECIBIDO:', snap.val() ? Object.keys(snap.val()).length + ' productos' : 'VACÃO');
    
    productos = snap.val() || {};
    
    totalesGlobales.bea = 0;
    totalesGlobales.laura = 0;
    totalesGlobales.vendidos = 0;
    totalesGlobales.reservados = 0;
    
    Object.values(productos).forEach(p => {
      totalesGlobales.bea += Number(p.vBea || 0);
      totalesGlobales.laura += Number(p.vLaura || 0);
      totalesGlobales.vendidos += Number(p.vendidos || 0);
      totalesGlobales.reservados += Number(p.reservados || 0);
    });
    
    console.log('ğŸ’° Totales calculados:', totalesGlobales);
    actualizarTotales(totalesGlobales.bea, totalesGlobales.laura, totalesGlobales.vendidos, totalesGlobales.reservados);
    renderTablaSolo();
    
  }, (error) => {
    console.error('âŒ ERROR DETALLADO:', error);
    console.error('ğŸ“ CÃ³digo:', error.code);
    console.error('ğŸ“„ Mensaje:', error.message);
    document.getElementById('status').textContent = `âŒ Error: ${error.code} - ${error.message}`;
    document.getElementById('status').className = 'error';
  });
  
  console.log('ğŸ” === DEBUG LOAD DATA FINALIZADO ===');
}


function ordenarProductos(productosObj) {
  const orden = document.getElementById('ordenar').value;
  const entradas = Object.entries(productosObj);
  
  return entradas.sort((a, b) => {
    const pA = a[1], pB = b[1];
    const [campo, dir] = orden.split('-');
    
    let valorA, valorB;
    
    switch(campo) {
      case 'nombre':
        valorA = (pA.nombre || '').toLowerCase();
        valorB = (pB.nombre || '').toLowerCase();
        return dir === 'asc' ? valorA.localeCompare(valorB) : valorB.localeCompare(valorA);
      case 'stock': case 'vendidos': case 'reservados':
        valorA = pA[campo] || 0;
        valorB = pB[campo] || 0;
        break;
      case 'bea':
        valorA = pA.bea || 0;
        valorB = pB.bea || 0;
        break;
      case 'laura':
        valorA = pA.laura || 0;
        valorB = pB.laura || 0;
        break;
    }
    
    return dir === 'asc' ? valorA - valorB : valorB - valorA;
  });
}

function actualizarTotales(totalBea, totalLaura, totalVendidos, totalReservados) {
  document.getElementById('tBeaSup').textContent = `â‚¬${totalBea.toFixed(2)}`;
  document.getElementById('tLauraSup').textContent = `â‚¬${totalLaura.toFixed(2)}`;
  document.getElementById('tTotalReservadosSup').textContent = totalReservados;
  document.getElementById('tTotalVendidosSup').textContent = totalVendidos;
  
  document.getElementById('tBea').textContent = `â‚¬${totalBea.toFixed(2)}`;
  document.getElementById('tLaura').textContent = `â‚¬${totalLaura.toFixed(2)}`;
  document.getElementById('tTotalReservados').textContent = totalReservados;
  document.getElementById('tTotalVendidos').textContent = totalVendidos;
  
  const diferencia = totalLaura - totalBea;
  const diferenciaSup = document.getElementById('tDiferenciaSup');
  const diferenciaBoxSup = document.getElementById('diferenciaBoxSup');
  const diferenciaInf = document.getElementById('tDiferencia');
  const diferenciaBoxInf = document.getElementById('diferenciaBox');
  
  diferenciaSup.textContent = `â‚¬${diferencia.toFixed(2)}`;
  diferenciaInf.textContent = `â‚¬${diferencia.toFixed(2)}`;
  
  if(diferencia > 0) {
    diferenciaSup.className = 'diferencia-positiva';
    diferenciaBoxSup.className = 'total-box-superior diferencia bea';
    diferenciaInf.className = 'diferencia-positiva';
    diferenciaBoxInf.className = 'total-box diferencia-positiva';
  } else if(diferencia < 0) {
    diferenciaSup.className = 'diferencia-negativa';
    diferenciaBoxSup.className = 'total-box-superior diferencia';
    diferenciaInf.className = 'diferencia-negativa';
    diferenciaBoxInf.className = 'total-box diferencia-negativa';
  } else {
    diferenciaSup.className = '';
    diferenciaBoxSup.className = 'total-box-superior diferencia';
    diferenciaInf.className = '';
    diferenciaBoxInf.className = 'total-box';
  }
}

window.reservar = async (id, cant) => {
  const p = productos[id];
  cant = Number(cant);
  if(cant<=0 || (p.stock||0)<cant) return alert('âŒ Stock insuficiente');
  
  const nuevoStock = (p.stock||0)-cant;
  const nuevosReservados = (p.reservados||0)+cant;
  
  await update(ref(db, 'productos/'+id), {
    stock: nuevoStock,
    reservados: nuevosReservados
  });
  
  await enviarEmail({
    producto: p.nombre,
    stock: nuevoStock,
    detalles: `${cant} uds. RESERVADAS | Stock disponible: ${nuevoStock}`,
    subject: 'â³ RESERVA - ' + p.nombre,
    fecha: new Date().toLocaleString('es-ES')
  });
  
  alert(`âœ… Reservadas ${cant} unidades. Stock disponible: ${nuevoStock}`);
};

window.vender = async (id, cant) => {
  const p = productos[id];
  cant = Number(cant);
  if(cant<=0 || (p.stock||0)<cant) return alert('âŒ Stock insuficiente');
  
  const nuevoStock = (p.stock||0)-cant;
  const eraStockCero = (p.stock||0) === 0;
  
  await update(ref(db, 'productos/'+id), {
    stock: nuevoStock,
    vendidos: (p.vendidos||0)+cant,
    vBea: (p.vBea||0)+(p.bea||0)*cant,
    vLaura: (p.vLaura||0)+(p.laura||0)*cant
  });
  
  if (nuevoStock === 0 && !eraStockCero && !p.emailAgotadoEnviado) {
    await update(ref(db, 'productos/'+id), { emailAgotadoEnviado: true });
    await enviarEmail({
      producto: p.nombre,
      stock: 0,
      detalles: `â›” PRODUCTO AGOTADO | Bea: â‚¬${(p.bea||0).toFixed(2)} | Laura: â‚¬${(p.laura||0).toFixed(2)}`,
      subject: 'â›” AGOTADO - ' + p.nombre,
      fecha: new Date().toLocaleString('es-ES')
    });
  }
  
  await enviarEmail({
    producto: p.nombre,
    stock: nuevoStock,
    detalles: `${cant} uds. | Bea: â‚¬${(p.bea||0).toFixed(2)} | Laura: â‚¬${(p.laura||0).toFixed(2)}`,
    subject: 'ğŸ›’ VENTA - ' + p.nombre,
    fecha: new Date().toLocaleString('es-ES')
  });
  
  alert(`âœ… Vendido ${cant} unidades${nuevoStock === 0 ? ' (AGOTADO)' : ''}`);
};

window.cancelarReserva = async (id, cant) => {
  const p = productos[id];
  cant = Number(cant);
  const reservados = p.reservados || 0;
  if(cant<=0 || cant>reservados) return alert('âŒ Cantidad invÃ¡lida');
  
  const nuevoStock = (p.stock||0)+cant;
  const nuevosReservados = reservados - cant;
  
  await update(ref(db, 'productos/'+id), {
    stock: nuevoStock,
    reservados: nuevosReservados
  });
  
  await enviarEmail({
    producto: p.nombre,
    stock: nuevoStock,
    detalles: `${cant} uds. RESERVA CANCELADA | Stock devuelto: ${nuevoStock}`,
    subject: 'âŒ RESERVA CANCELADA - ' + p.nombre,
    fecha: new Date().toLocaleString('es-ES')
  });
  
  alert(`âœ… Canceladas ${cant} unidades. Stock: ${nuevoStock}`);
};

window.eliminarUnaVenta = async (id) => {
  if (userRole !== 'admin') return alert('âŒ Solo ADMIN puede eliminar ventas');
  const p = productos[id];
  const vendidos = p.vendidos || 0;
  if (vendidos === 0) return alert('âŒ No hay ventas para eliminar');
  
  if (!confirm(`â†©ï¸ Â¿Eliminar 1 venta de "${p.nombre}"?\n\nâœ… +1 stock\nâœ… -1 vendidos\nâœ… Resta â‚¬${p.bea?.toFixed(2)} Bea / â‚¬${p.laura?.toFixed(2)} Laura`)) return;
  
  const nuevoStock = (p.stock || 0) + 1;
  const nuevosVendidos = vendidos - 1;
  const nuevoVBea = Math.max(0, (p.vBea || 0) - (p.bea || 0));
  const nuevoVLaura = Math.max(0, (p.vLaura || 0) - (p.laura || 0));
  
  await update(ref(db, 'productos/'+id), {
    stock: nuevoStock,
    vendidos: nuevosVendidos,
    vBea: nuevoVBea,
    vLaura: nuevoVLaura
  });
  
  await enviarEmail({
    producto: p.nombre,
    stock: nuevoStock,
    detalles: `â†©ï¸ 1 VENTA ELIMINADA | +1 stock | Vendidos: ${nuevosVendidos}`,
    subject: 'â†©ï¸ VENTA CORREGIDA - ' + p.nombre,
    fecha: new Date().toLocaleString('es-ES')
  });
  
  alert(`âœ… Eliminada 1 venta. Stock: ${nuevoStock}`);
};

window.modificarStock = (id) => {
  if (userRole !== 'admin') return alert('âŒ Solo ADMIN puede modificar stock');
  const nuevoStock = prompt('ğŸ“¦ Nuevo stock:', productos[id]?.stock || '0');
  if (nuevoStock === null) return;
  const stock = Math.max(0, Number(nuevoStock));
  if (isNaN(stock)) return alert('âŒ Stock invÃ¡lido');
  
  update(ref(db, 'productos/'+id), { stock: stock })
    .then(() => {
      alert(`âœ… Stock actualizado: ${stock}`);
      if (stock > 0 && productos[id]?.emailAgotadoEnviado) {
        update(ref(db, 'productos/'+id), { emailAgotadoEnviado: false });
      }
    });
};

window.guardar = () => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede crear/editar');
  const nombre = document.getElementById('nombre').value.trim();
  if(!nombre) return alert('âŒ Nombre requerido');
  
  const data = {
    nombre, 
    stock: Math.max(0, Number(document.getElementById('stock').value)||0),
    bea: Math.max(0, Number(document.getElementById('bea').value)||0),
    laura: Math.max(0, Number(document.getElementById('laura').value)||0),
    vendidos: editId ? (productos[editId]?.vendidos||0) : 0,
    reservados: editId ? (productos[editId]?.reservados||0) : 0,
    vBea: editId ? (productos[editId]?.vBea||0) : 0,
    vLaura: editId ? (productos[editId]?.vLaura||0) : 0
  };

  if(editId) update(ref(db, 'productos/'+editId), data).then(() => {limpiarFormulario(); alert('âœ… Actualizado')});
  else push(productosRef, data).then(() => {limpiarFormulario(); alert('âœ… Guardado')});
};

window.modificarPrecioLaura = (id) => {
  const nuevoPrecio = prompt('ğŸ’° Nuevo precio Laura:', productos[id]?.laura || '0');
  if(nuevoPrecio === null) return;
  const precio = Math.max(0, Number(nuevoPrecio));
  if(isNaN(precio)) return alert('âŒ Precio invÃ¡lido');
  update(ref(db, 'productos/'+id), { laura: precio }).then(() => alert(`âœ… Laura: â‚¬${precio.toFixed(2)}`));
};

window.modificarPrecioLauraGlobal = () => {
  const nuevoPrecio = prompt('ğŸ’° Nuevo precio Laura para TODOS:', '0');
  if(nuevoPrecio === null) return;
  const precio = Math.max(0, Number(nuevoPrecio));
  if(isNaN(precio)) return alert('âŒ Precio invÃ¡lido');
  
  const updates = {};
  Object.entries(productos).forEach(([id]) => updates[`productos/${id}/laura`] = precio);
  update(ref(db), updates).then(() => alert(`âœ… Laura GLOBAL: â‚¬${precio.toFixed(2)}`));
};

window.editar = id => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede editar');
  const p = productos[id];
  document.getElementById('nombre').value = p.nombre||'';
  document.getElementById('stock').value = p.stock||0;
  document.getElementById('bea').value = p.bea||0;
  document.getElementById('laura').value = p.laura||0;
  editId = id;
  document.getElementById('cancelBtn').style.display = 'inline-block';
};

window.borrar = id => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede borrar');
  if(confirm(`ğŸ—‘ï¸ Borrar "${productos[id]?.nombre||'Producto'}"?`)) {
    remove(ref(db, 'productos/'+id)).then(() => alert('âœ… Borrado'));
  }
};

window.resetear = () => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede resetear');
  if(confirm('âš ï¸ Â¿Resetear COMPLETAMENTE?\nâœ… Stock se mantiene\nâŒ Se pierden: ventas, vendidos, reservados')) {
    const updates = {};
    Object.entries(productos).forEach(([id]) => {
      updates[`productos/${id}/vBea`] = 0;
      updates[`productos/${id}/vLaura`] = 0;
      updates[`productos/${id}/vendidos`] = 0;
      updates[`productos/${id}/reservados`] = 0;
      updates[`productos/${id}/emailAgotadoEnviado`] = false;
    });
    update(ref(db), updates).then(() => alert('âœ… ğŸ”„ RESET COMPLETO'));
  }
};

window.cancelarEdit = () => limpiarFormulario();

function limpiarFormulario() {
  document.getElementById('nombre').value = '';
  document.getElementById('stock').value = '';
  document.getElementById('bea').value = '';
  document.getElementById('laura').value = '';
  editId = null;
  document.getElementById('cancelBtn').style.display = 'none';
};
</script>
</body>
</html>













