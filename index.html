<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Laura Online - MultiUsuario</title>
<style>
body{font-family:Arial;background:#f0f2f5;padding:20px;max-width:1400px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px}
th{background:#007bff;color:white}
button{padding:6px 10px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:12px;margin:1px;font-weight:bold}
button:hover{background:#0056b3}
.red{background:#dc3545}
.red:hover{background:#c82333}
.sin-stock{background:#ffe5e5 !important}
.stock-bajo{background:#fff3cd !important}
input{padding:6px;border-radius:5px;border:1px solid #ccc;width:60px;font-size:12px}
#buscar{width:250px;padding:10px;font-size:16px}
#status{padding:15px;margin-bottom:20px;border-radius:8px;text-align:center;font-weight:bold;font-size:16px}
.admin{background:#d4edda;color:#155724;border:2px solid #c3e6cb}
.user{background:#d1ecf1;color:#0c5460;border:2px solid #bee5eb}
.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb}
.login-card{background:#fff3cd;border:2px solid #ffeaa7}
.hidden{display:none}
.disabled{background:#ccc !important;cursor:not-allowed !important}
.diferencia-positiva{background:#d4edda !important;color:#155724;font-weight:bold}
.diferencia-negativa{background:#f8d7da !important;color:#721c24;font-weight:bold}
.totales-container{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:15px;text-align:center;font-size:18px;font-weight:bold;padding:20px}
.total-box{padding:12px;border-radius:10px}
.editable{background:#fff3cd !important}
.vendidos{font-weight:bold;color:#28a745}
</style>
</head>
<body>

<h2>ğŸ›’ Inventario Laura Online - CON VENDIDOS</h2>

<!-- LOGIN OBLIGATORIO -->
<div class="card login-card" id="loginDiv">
  <h3>ğŸ” Iniciar SesiÃ³n</h3>
  <input id="userEmail" type="email" placeholder="Email" list="userList"><br>
  <input id="userPass" type="password" placeholder="ContraseÃ±a"><br><br>
  
  <datalist id="userList">
    <option value="nilose2014@gmail.com">ğŸ‘‘ ADMIN</option>
    <option value="djsubixj@gmail.com">ğŸ‘¤ Usuario</option>
    <option value="xiomaralamasmala@gmail.com">ğŸ‘¤ Usuario</option>
  </datalist>
  
  <button onclick="login()">ğŸš€ Entrar</button>
  <button class="red" onclick="resetLogin()">ğŸ”„ Limpiar</button>
</div>

<div id="mainApp" style="display:none">

<div id="status" class="error">Cargando...</div>

<div class="card">
<strong>ğŸ“¦ Nuevo/Editar Producto:</strong><br><br>
Producto <input id="nombre" placeholder="Nombre del producto"><br>
Stock <input id="stock" type="number" placeholder="0"><br>
Precio Bea <input id="bea" type="number" step="0.01" placeholder="0.00"><br>
Precio Laura <input id="laura" type="number" step="0.01" placeholder="0.00"><br><br>
<button onclick="guardar()" id="guardarBtn">ğŸ’¾ Guardar Nuevo</button>
<button class="red" onclick="cancelarEdit()" id="cancelBtn" style="display:none">âŒ Cancelar</button>
</div>

<div class="card">
ğŸ” <input placeholder="Buscar producto..." id="buscar" onkeyup="render()"><br><br>
<table>
<thead>
<tr>
<th>Producto</th><th>Stock</th><th>Vendidos</th><th>Bea â‚¬</th><th>Laura â‚¬</th><th>Vender</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- TOTALES CON VENDIDOS -->
<div class="totales-container">
  <div class="total-box">
    <strong>ğŸ’° Venta Bea</strong><br>
    <span id="tBea" style="font-size:24px">â‚¬0.00</span>
  </div>
  <div class="total-box">
    <strong>ğŸ’° Venta Laura</strong><br>
    <span id="tLaura" style="font-size:24px">â‚¬0.00</span>
  </div>
  <div class="total-box" id="diferenciaBox">
    <strong>ğŸ“Š Diferencia (L-B)</strong><br>
    <span id="tDiferencia" style="font-size:24px">â‚¬0.00</span>
  </div>
  <div class="total-box vendidos">
    <strong>ğŸ“¦ Total Vendidos</strong><br>
    <span id="tTotalVendidos" style="font-size:24px">0</span>
  </div>
</div>

<div class="card" style="text-align:center">
<button class="red" onclick="resetear()" id="resetBtn">ğŸ”„ Resetear Ventas</button>
<button onclick="modificarPrecioLauraGlobal()" id="precioGlobalBtn">ğŸ’² Precio Laura Global</button>
<button onclick="logout()" style="background:#28a745">ğŸ” Cambiar Usuario</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const productosRef = ref(db, "productos");

let productos = {};
let editId = null;
let currentUser = null;
let userRole = null;

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    checkUserRole();
  } else {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginDiv').style.display = 'block';
  }
});

window.login = () => {
  const email = document.getElementById('userEmail').value.trim();
  const pass = document.getElementById('userPass').value;
  if(!email || !pass) return alert('âŒ Email y contraseÃ±a requeridos');
  signInWithEmailAndPassword(auth, email, pass)
    .catch(e => alert('âŒ Error: ' + e.message));
};

window.logout = () => {
  signOut(auth).catch(e => alert('âŒ Error: ' + e.message));
};

window.resetLogin = () => {
  document.getElementById('userEmail').value = '';
  document.getElementById('userPass').value = '';
};

function checkUserRole() {
  if(currentUser.email === 'nilose2014@gmail.com') {
    userRole = 'admin';
  } else if(['djsubixj@gmail.com', 'xiomaralamasmala@gmail.com'].includes(currentUser.email)) {
    userRole = 'user';
  } else {
    userRole = 'user';
  }
  updateUI();
  loadData();
}

function updateUI() {
  const status = document.getElementById('status');
  const guardarBtn = document.getElementById('guardarBtn');
  const resetBtn = document.getElementById('resetBtn');
  const precioGlobalBtn = document.getElementById('precioGlobalBtn');
  
  if(userRole === 'admin') {
    status.innerHTML = `ğŸ‘‘ <strong>ADMIN:</strong> ${currentUser.email}<br>Todos los permisos âœ…`;
    status.className = 'admin';
    guardarBtn.disabled = false;
    guardarBtn.className = '';
    resetBtn.disabled = false;
    resetBtn.className = '';
    precioGlobalBtn.disabled = false;
  } else {
    status.innerHTML = `ğŸ‘¤ <strong>USUARIO:</strong> ${currentUser.email}<br>Solo ventas + precio Laura âœ…`;
    status.className = 'user';
    guardarBtn.disabled = true;
    guardarBtn.className = 'disabled';
    resetBtn.disabled = true;
    resetBtn.className = 'disabled';
    precioGlobalBtn.disabled = false;
    precioGlobalBtn.className = '';
  }
}

function loadData() {
  onValue(productosRef, (snap) => {
    productos = snap.val() || {};
    render();
  }, (error) => {
    document.getElementById('status').textContent = 'âŒ Error de conexiÃ³n';
    document.getElementById('status').className = 'error';
  });
}

window.guardar = () => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede crear/editar');
  const nombre = document.getElementById('nombre').value.trim();
  if(!nombre) return alert('âŒ Nombre requerido');
  
  const data = {
    nombre, 
    stock: Math.max(0, Number(document.getElementById('stock').value)||0),
    bea: Math.max(0, Number(document.getElementById('bea').value)||0),
    laura: Math.max(0, Number(document.getElementById('laura').value)||0),
    vendidos: editId ? (productos[editId]?.vendidos||0) : 0,
    vBea: editId ? (productos[editId]?.vBea||0) : 0,
    vLaura: editId ? (productos[editId]?.vLaura||0) : 0
  };

  if(editId) {
    update(ref(db, 'productos/'+editId), data).then(() => {limpiarFormulario(); alert('âœ… Actualizado')});
  } else {
    push(productosRef, data).then(() => {limpiarFormulario(); alert('âœ… Guardado')});
  }
};

window.modificarPrecioLaura = (id) => {
  const nuevoPrecio = prompt('ğŸ’° Nuevo precio Laura:', productos[id]?.laura || '0');
  if(nuevoPrecio === null) return;
  const precio = Math.max(0, Number(nuevoPrecio));
  if(isNaN(precio)) return alert('âŒ Precio invÃ¡lido');
  update(ref(db, 'productos/'+id), { laura: precio })
    .then(() => alert(`âœ… Laura: â‚¬${precio.toFixed(2)}`));
};

window.modificarPrecioLauraGlobal = () => {
  const nuevoPrecio = prompt('ğŸ’° Nuevo precio Laura para TODOS:', '0');
  if(nuevoPrecio === null) return;
  const precio = Math.max(0, Number(nuevoPrecio));
  if(isNaN(precio)) return alert('âŒ Precio invÃ¡lido');
  
  const updates = {};
  Object.entries(productos).forEach(([id]) => {
    updates[`productos/${id}/laura`] = precio;
  });
  update(ref(db), updates).then(() => alert(`âœ… Laura GLOBAL: â‚¬${precio.toFixed(2)}`));
};

// ğŸ†• VENTA CON CONTADOR VENDIDOS
window.vender = (id,cant) => {
  const p = productos[id];
  cant = Number(cant);
  if(cant<=0 || (p.stock||0)<cant) return alert('âŒ Stock insuficiente');
  
  update(ref(db, 'productos/'+id), {
    stock: (p.stock||0)-cant,
    vendidos: (p.vendidos||0)+cant,
    vBea: (p.vBea||0)+(p.bea||0)*cant,
    vLaura: (p.vLaura||0)+(p.laura||0)*cant
  }).then(() => alert(`âœ… Vendido ${cant} unidades`));
};

window.editar = id => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede editar');
  const p = productos[id];
  document.getElementById('nombre').value = p.nombre||'';
  document.getElementById('stock').value = p.stock||0;
  document.getElementById('bea').value = p.bea||0;
  document.getElementById('laura').value = p.laura||0;
  editId = id;
  document.getElementById('cancelBtn').style.display = 'inline-block';
};

window.borrar = id => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede borrar');
  if(confirm(`ğŸ—‘ï¸ Borrar "${productos[id]?.nombre||'Producto'}"?`)) {
    remove(ref(db, 'productos/'+id)).then(() => alert('âœ… Borrado'));
  }
};

// ğŸ†• RESET MANTIENE CONTADORES VENDIDOS
window.resetear = () => {
  if(userRole !== 'admin') return alert('âŒ Solo ADMIN puede resetear');
  if(confirm('ğŸ”„ Â¿Resetear SOLO ventas (precios)? Contadores VENDIDOS se mantienen.')) {
    const updates = {};
    Object.entries(productos).forEach(([id]) => {
      updates[`productos/${id}/vBea`] = 0;
      updates[`productos/${id}/vLaura`] = 0;
    });
    update(ref(db), updates).then(() => alert('âœ… Ventas reseteadas (contadores intactos)'));
  }
};

function limpiarFormulario() {
  document.getElementById('nombre').value = 
  document.getElementById('stock').value = 
  document.getElementById('bea').value = 
  document.getElementById('laura').value = '';
  editId = null;
  document.getElementById('cancelBtn').style.display = 'none';
}

window.render = () => {
  const filtro = document.getElementById('buscar').value.toLowerCase();
  let totalBea = 0, totalLaura = 0, totalVendidos = 0;
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = '';

  Object.entries(productos).forEach(([id,p]) => {
    if(!p?.nombre?.toLowerCase().includes(filtro)) return;
    totalBea += Number(p.vBea||0);
    totalLaura += Number(p.vLaura||0);
    totalVendidos += Number(p.vendidos||0);
    
    const stockClass = (p.stock||0)<=0 ? 'sin-stock' : (p.stock||0)<=5 ? 'stock-bajo' : '';
    
    tabla.innerHTML += `
    <tr class="${stockClass}">
      <td style="font-weight:bold;text-align:left">${p.nombre}</td>
      <td>${p.stock||0}</td>
      <td class="vendidos">${p.vendidos||0}</td>
      <td>${Number(p.bea||0).toFixed(2)}</td>
      <td class="editable">
        <strong>${Number(p.laura||0).toFixed(2)}</strong>
        <button onclick="modificarPrecioLaura('${id}')" style="font-size:10px;padding:1px 4px;margin-left:3px">ğŸ’²</button>
      </td>
      <td>
        <input type="number" min="1" max="${p.stock||0}" value="1" style="width:50px">
        <button onclick="vender('${id}',this.previousElementSibling.value)">ğŸ›’</button>
      </td>
      <td>
        <button onclick="editar('${id}')" ${userRole !== 'admin' ? 'class="disabled" disabled' : ''}>âœï¸</button>
        <button class="red" onclick="borrar('${id}')" ${userRole !== 'admin' ? 'class="disabled" disabled' : ''}>ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  });

  document.getElementById('tBea').textContent = `â‚¬${totalBea.toFixed(2)}`;
  document.getElementById('tLaura').textContent = `â‚¬${totalLaura.toFixed(2)}`;
  document.getElementById('tTotalVendidos').textContent = totalVendidos;
  
  const diferencia = totalLaura - totalBea;
  const diferenciaSpan = document.getElementById('tDiferencia');
  const diferenciaBox = document.getElementById('diferenciaBox');
  
  diferenciaSpan.textContent = `â‚¬${diferencia.toFixed(2)}`;
  if(diferencia > 0) {
    diferenciaSpan.className = 'diferencia-positiva';
    diferenciaBox.className = 'total-box diferencia-positiva';
  } else if(diferencia < 0) {
    diferenciaSpan.className = 'diferencia-negativa';
    diferenciaBox.className = 'total-box diferencia-negativa';
  } else {
    diferenciaSpan.className = '';
    diferenciaBox.className = 'total-box';
  }
};
</script>
</body>
</html>




