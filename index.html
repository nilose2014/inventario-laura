<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Laura Online</title>
<style>
body{font-family:Arial;background:#f0f2f5;padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#f8f9fa}
button{padding:6px 10px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:12px}
button:hover{background:#0056b3}
.red{background:#dc3545}
.red:hover{background:#c82333}
.sin-stock{background:#ffe5e5}
input{padding:5px;border-radius:5px;border:1px solid #ccc;width:100px}
#buscar{width:200px}
#status{padding:10px;margin-bottom:10px;border-radius:5px}
.connected{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.disconnected{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.hidden{display:none}
</style>
</head>
<body>

<h2>Inventario y Ventas</h2>

<div id="status" class="disconnected">Conectando...</div>

<div class="card">
Producto <input id="nombre"><br><br>
Stock <input id="stock" type="number"><br><br>
Precio Bea <input id="bea" type="number"><br><br>
Precio Laura <input id="laura" type="number"><br><br>
<button onclick="guardar()">Guardar</button>
<button class="red" onclick="cancelarEdit()">Cancelar</button>
</div>

<div class="card">
<input placeholder="Buscar producto" id="buscar" onkeyup="render()">
<table>
<thead>
<tr>
<th>Producto</th><th>Stock</th><th>Bea</th><th>Laura</th><th>Vender</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<div class="card">
Venta Bea: €<span id="tBea">0</span><br>
Venta Laura: €<span id="tLaura">0</span><br>
<button class="red" onclick="resetear()">Resetear ventas</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const productosRef = ref(db, "productos");
const statusRef = ref(db, "status/online");

let productos = {};
let editId = null;
let totalBea = 0;
let totalLaura = 0;
let userId = null;

// Autenticación anónima
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, user => {
  userId = user ? user.uid : null;
  updateStatus();
  if(user) {
    // Marcar como conectado
    onDisconnect(statusRef).remove();
  }
});

// Estado de conexión
function updateStatus() {
  const status = document.getElementById('status');
  if(userId) {
    status.textContent = 'Conectado como usuario anónimo';
    status.className = 'connected';
  } else {
    status.textContent = 'Conectando...';
    status.className = 'disconnected';
  }
}

onValue(productosRef, snap => {
  productos = snap.val() || {};
  render();
});

window.guardar = () => {
  if(!userId) return alert('Esperando conexión...');
  
  const data = {
    nombre: document.getElementById('nombre').value.trim(),
    stock: Number(document.getElementById('stock').value)||0,
    bea: Number(document.getElementById('bea').value)||0,
    laura: Number(document.getElementById('laura').value)||0,
    vBea: 0,
    vLaura: 0
  };

  if(!data.nombre) return alert('Nombre requerido');

  if(editId){
    update(ref(db,'productos/'+editId), data);
    editId = null;
  } else {
    push(productosRef, data);
  }

  document.getElementById('nombre').value = 
  document.getElementById('stock').value = 
  document.getElementById('bea').value = 
  document.getElementById('laura').value = '';
};

window.vender = (id, cant) => {
  if(!userId) return;
  const p = productos[id];
  cant = Number(cant);
  if(cant <= 0 || p.stock < cant) return alert('Stock insuficiente');

  update(ref(db,'productos/'+id), {
    stock: p.stock - cant,
    vBea: (p.vBea||0) + p.bea * cant,
    vLaura: (p.vLaura||0) + p.laura * cant
  });
};

window.editar = id => {
  const p = productos[id];
  document.getElementById('nombre').value = p.nombre;
  document.getElementById('stock').value = p.stock;
  document.getElementById('bea').value = p.bea;
  document.getElementById('laura').value = p.laura;
  editId = id;
};

window.borrar = id => {
  if(!userId) return;
  if(confirm('¿Borrar este producto permanentemente?')) {
    remove(ref(db, 'productos/' + id));
  }
};

window.cancelarEdit = () => {
  editId = null;
  document.getElementById('nombre').value = 
  document.getElementById('stock').value = 
  document.getElementById('bea').value = 
  document.getElementById('laura').value = '';
};

window.resetear = () => {
  if(!userId || !confirm('¿Resetear TODAS las ventas?')) return;
  Object.entries(productos).forEach(([id]) => {
    update(ref(db,'productos/'+id), {vBea: 0, vLaura: 0});
  });
};

window.render = () => {
  const filtro = document.getElementById('buscar').value.toLowerCase();
  totalBea = 0; 
  totalLaura = 0;
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = '';

  Object.entries(productos).forEach(([id, p]) => {
    if(!p.nombre || !p.nombre.toLowerCase().includes(filtro)) return;
    
    totalBea += p.vBea || 0;
    totalLaura += p.vLaura || 0;
    
    tabla.innerHTML += `
    <tr class="${p.stock <= 0 ? 'sin-stock' : ''}">
      <td>${p.nombre}</td>
      <td>${p.stock}</td>
      <td>€${p.bea}</td>
      <td>€${p.laura}</td>
      <td>
        <input type="number" min="1" max="${p.stock}" value="1" style="width:50px">
        <button onclick="vender('${id}',this.previousElementSibling.value)">Vender</button>
      </td>
      <td>
        <button onclick="editar('${id}')">Editar</button>
        <button class="red" onclick="borrar('${id}')">Borrar</button>
      </td>
    </tr>`;
  });

  document.getElementById('tBea').innerText = totalBea.toFixed(2);
  document.getElementById('tLaura').innerText = totalLaura.toFixed(2);
};
</script>

</body>
</html>

