<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üìä Estad√≠sticas Inventario Laura - Todos Vendidos</title>
<style>
body{font-family:Arial;background:#f0f2f5;padding:20px;max-width:1200px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
th{background:linear-gradient(45deg,#28a745,#20c997);color:white}
tr:nth-child(even){background:#f8f9fa}
tr:hover{background:#e3f2fd}
.pos1{background:#d4edda !important;font-weight:bold}
.pos2{background:#fff3cd !important;font-weight:bold}
.pos3{background:#cce7ff !important;font-weight:bold}
h2{margin-top:0}
button{padding:6px 10px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:12px;font-weight:bold;margin-left:5px}
button:hover{background:#0056b3}
.admin{background:#d4edda;color:#155724;border:2px solid #c3e6cb;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-weight:bold}
.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-weight:bold}
.tabla-container{overflow:auto}

@media print {
  body{background:white;padding:0;margin:0}
  button, #status, h2 {display:none !important}
  .card{box-shadow:none;padding:0}
  .tabla-container{overflow:visible}
}
</style>
</head>
<body>

<h2>üìä Estad√≠sticas de Productos Vendidos (Hist√≥rico Completo)</h2>

<div id="status" class="admin">Cargando...</div>

<div class="card" id="cardEstadisticas">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <div>
      <strong>Total productos con ventas:</strong>
      <span id="totalProductosVendidos" style="color:#28a745;font-weight:bold">0</span><br>
      <strong>Total unidades vendidas:</strong>
      <span id="totalUnidadesVendidas" style="color:#007bff;font-weight:bold">0</span><br>
      <!-- TOTAL UNIDADES A LA VENTA (TODOS LOS PRODUCTOS) -->
      <strong>Total unidades a la venta:</strong>
      <span id="totalUnidadesVenta" style="color:#dc3545;font-weight:bold">0</span><br>
      <!-- TOTALES ECON√ìMICOS -->
      <strong>Total Bea ‚Ç¨:</strong>
      <span id="totalBea" style="color:#28a745;font-weight:bold">‚Ç¨0.00</span><br>
      <strong>Total Laura ‚Ç¨:</strong>
      <span id="totalLaura" style="color:#007bff;font-weight:bold">‚Ç¨0.00</span>
    </div>
    <div>
      <button onclick="imprimir()">üñ®Ô∏è Imprimir</button>
      <button onclick="descargarPDF()">‚¨áÔ∏è Descargar PDF</button>
      <button onclick="volver()">‚¨ÖÔ∏è Volver al Inventario</button>
    </div>
  </div>
  <div class="tabla-container">
    <table>
      <thead>
        <tr>
          <th>Pos</th>
          <th>Producto</th>
          <th>Vendidos</th>
          <th>Bea ‚Ç¨</th>
          <th>Laura ‚Ç¨</th>
          <th>% Vendidos</th>
        </tr>
      </thead>
      <tbody id="tablaEstadisticas"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const productosRef = ref(db, "productos");

let productos = {};

onAuthStateChanged(auth, (user) => {
  const status = document.getElementById('status');
  if (!user) {
    status.className = 'error';
    status.textContent = '‚ùå Debes iniciar sesi√≥n como ADMIN para ver las estad√≠sticas.';
    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
    return;
  }
  if (user.email !== 'nilose2014@gmail.com') {
    status.className = 'error';
    status.textContent = '‚ùå Solo el ADMIN (nilose2014@gmail.com) puede ver esta p√°gina.';
    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
    return;
  }
  status.className = 'admin';
  status.textContent = `üëë ADMIN: ${user.email} - Estad√≠sticas completas cargadas ‚úÖ`;
  cargarEstadisticas();
});

function cargarEstadisticas() {
  onValue(productosRef, (snap) => {
    productos = snap.val() || {};
    mostrarEstadisticasCompletas();
  }, (error) => {
    const status = document.getElementById('status');
    status.className = 'error';
    status.textContent = '‚ùå Error cargando datos: ' + error.message;
  });
}

function mostrarEstadisticasCompletas() {
  const tablaEstadisticas = document.getElementById('tablaEstadisticas');
  const totalProductosVendidosEl = document.getElementById('totalProductosVendidos');
  const totalUnidadesVendidasEl = document.getElementById('totalUnidadesVendidas');
  const totalUnidadesVentaEl = document.getElementById('totalUnidadesVenta');
  const totalBeaEl = document.getElementById('totalBea');
  const totalLauraEl = document.getElementById('totalLaura');

  const todosProductos = Object.entries(productos);

  // TOTAL UNIDADES A LA VENTA: suma del campo "stock" de TODOS los productos
  // Cambia "stock" por el nombre real de tu campo si es distinto.
  const totalUnidadesVenta = todosProductos.reduce((acc, [,p]) => {
    return acc + Number(p.stock || 0);
  }, 0);

  const todosConVentas = todosProductos
    .filter(([id,p]) => Number(p.vendidos || 0) > 0)
    .sort(([,a], [,b]) => Number(b.vendidos || 0) - Number(a.vendidos || 0));

  const totalVendidosGlobal = todosConVentas.reduce((acc, [,p]) => acc + Number(p.vendidos || 0), 0);

  let totalBeaGlobal = 0;
  let totalLauraGlobal = 0;

  // Pintar total unidades a la venta
  totalUnidadesVentaEl.textContent = String(totalUnidadesVenta);

  if (todosConVentas.length === 0) {
    tablaEstadisticas.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999">‚ùå No hay ventas registradas a√∫n</td></tr>';
    totalProductosVendidosEl.textContent = '0';
    totalUnidadesVendidasEl.textContent = '0';
    totalBeaEl.textContent = '‚Ç¨0.00';
    totalLauraEl.textContent = '‚Ç¨0.00';
    return;
  }

  totalProductosVendidosEl.textContent = String(todosConVentas.length);
  totalUnidadesVendidasEl.textContent = String(totalVendidosGlobal);

  tablaEstadisticas.innerHTML = todosConVentas.map(([id,p], index) => {
    const vendidos = Number(p.vendidos || 0);

    const beaTotalCalc = Number(
      p.vBea != null
        ? p.vBea
        : vendidos * Number(p.bea || 0)
    );
    const lauraTotalCalc = Number(
      p.vLaura != null
        ? p.vLaura
        : vendidos * Number(p.laura || 0)
    );

    totalBeaGlobal += beaTotalCalc;
    totalLauraGlobal += lauraTotalCalc;

    const beaTotal = beaTotalCalc.toFixed(2);
    const lauraTotal = lauraTotalCalc.toFixed(2);

    const porcentaje = totalVendidosGlobal > 0
      ? ((vendidos / totalVendidosGlobal) * 100).toFixed(1)
      : 0;

    let clasePos = '';
    if(index === 0) clasePos = 'pos1';
    else if(index === 1) clasePos = 'pos2';
    else if(index === 2) clasePos = 'pos3';

    return `
      <tr class="${clasePos}">
        <td style="font-weight:bold;font-size:16px">${index+1}</td>
        <td style="text-align:left;font-weight:bold">
          <a href="index.html?editId=${encodeURIComponent(id)}" style="color:#007bff;text-decoration:underline;cursor:pointer">
            ${p.nombre}
          </a>
        </td>
        <td style="font-size:18px;color:#28a745;font-weight:bold">${vendidos}</td>
        <td style="color:#28a745;font-weight:bold">‚Ç¨${beaTotal}</td>
        <td style="color:#007bff;font-weight:bold">‚Ç¨${lauraTotal}</td>
        <td style="color:#ffc107;font-weight:bold">${porcentaje}%</td>
      </tr>
    `;
  }).join('');

  totalBeaEl.textContent = '‚Ç¨' + totalBeaGlobal.toFixed(2);
  totalLauraEl.textContent = '‚Ç¨' + totalLauraGlobal.toFixed(2);
}

// --------- BOTONES EXTRA ---------
window.volver = () => {
  window.location.href = 'index.html';
};

window.imprimir = () => {
  window.print();
};

window.descargarPDF = async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const element = document.getElementById('cardEstadisticas');

  const canvas = await html2canvas(element, { 
    scale: 2,
    useCORS: true,
    logging: false,
    windowHeight: element.scrollHeight
  });

  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 10;
  const contentWidth = pageWidth - (margin * 2);

  const imgWidth = contentWidth;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  const marginTop = margin;
  const marginBottom = 15;
  const availableHeight = pageHeight - marginTop - marginBottom;

  let yPosition = marginTop;
  let sourceY = 0;
  let pageNum = 1;

  while (sourceY < canvas.height) {
    const canvasHeightForPage = (availableHeight * canvas.width) / imgWidth;

    if (pageNum > 1) {
      doc.addPage();
      yPosition = marginTop;
    }

    const pageCanvas = document.createElement('canvas');
    pageCanvas.width = canvas.width;
    pageCanvas.height = Math.min(canvasHeightForPage, canvas.height - sourceY);

    const ctx = pageCanvas.getContext('2d');
    ctx.drawImage(
      canvas,
      0, sourceY, 
      canvas.width, pageCanvas.height,
      0, 0, 
      canvas.width, pageCanvas.height
    );

    const pageImgData = pageCanvas.toDataURL('image/png');
    const pageImgHeight = (pageCanvas.height * imgWidth) / canvas.width;

    doc.addImage(pageImgData, 'PNG', margin, yPosition, imgWidth, pageImgHeight);

    sourceY += pageCanvas.height;
    pageNum++;
  }

  doc.save('estadisticas-inventario-laura.pdf');
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</body>
</html>
