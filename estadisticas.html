<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ“Š EstadÃ­sticas de Productos Vendidos</title>
<style>
body{font-family:Arial,sans-serif;background:#f0f2f5;padding:20px;max-width:1400px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse;margin:20px 0}
th,td{border:1px solid #ddd;padding:10px;text-align:center}
th{background:#007bff;color:white;font-weight:bold}
tr:hover{background:#f5f5f5}
button{padding:10px 15px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-weight:bold;margin:5px;transition:all 0.3s ease}
button:hover{background:#0056b3;transform:scale(1.05)}
.pdf-btn{background:#dc3545 !important}
.pdf-btn:hover{background:#c82333 !important}
.print-btn{background:#28a745 !important}
.print-btn:hover{background:#218838 !important}
.volver-btn{background:#6c757d !important}
.volver-btn:hover{background:#5a6268 !important}
h1{color:#333;border-bottom:3px solid #007bff;padding-bottom:10px}
h2{color:#555;margin-top:20px}
.filtros{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center}
input[type="text"],select{padding:8px;border:1px solid #ddd;border-radius:5px;font-size:14px}
.stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.stat-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:10px;text-align:center}
.stat-box h3{margin:0;font-size:14px;opacity:0.9}
.stat-box .value{font-size:28px;font-weight:bold;margin-top:10px}
.red{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%) !important}
.green{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%) !important}
.blue{background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%) !important}
.orange{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%) !important}
.acciones{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
@media print{
  body{margin:0;padding:0}
  .acciones,button{display:none}
  .card{box-shadow:none;page-break-inside:avoid}
  table{width:100%}
}
#estadisticasTable{width:100%;margin-top:15px}
.hidden{display:none}
.search-box{width:250px}
</style>
</head>
<body>

<div class="card">
<h1>ğŸ“Š EstadÃ­sticas de Productos Vendidos</h1>

<div class="acciones">
  <button class="print-btn" onclick="imprimirPagina()" title="Imprimir directamente">ğŸ–¨ï¸ Imprimir</button>
  <button class="pdf-btn" onclick="exportarPDF()" title="Descargar como PDF">ğŸ“¥ Descargar PDF</button>
  <button class="volver-btn" onclick="volverInventario()">â—€ï¸ Volver al Inventario</button>
</div>

<div class="stats-container" id="statsContainer"></div>

<div class="filtros">
  ğŸ” <input type="text" class="search-box" id="searchInput" placeholder="Buscar producto..." onkeyup="filtrarTabla()">
  ğŸ†š <select id="ordenarSelect" onchange="reordenarTabla()">
    <option value="vendidos-desc">Vendidos â†“</option>
    <option value="vendidos-asc">Vendidos â†‘</option>
    <option value="nombre-asc">Nombre A-Z</option>
    <option value="nombre-desc">Nombre Z-A</option>
    <option value="bea-desc">Venta Bea â†“</option>
    <option value="laura-desc">Venta Laura â†“</option>
  </select>
</div>

<table id="estadisticasTable">
<thead>
  <tr>
    <th>Producto</th>
    <th>ğŸ“¦ Vendidos</th>
    <th>ğŸ’° Bea (â‚¬)</th>
    <th>ğŸ’° Laura (â‚¬)</th>
    <th>ğŸ“Š Diferencia (â‚¬)</th>
    <th>ğŸ’¹ Margen %</th>
  </tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

<div class="stats-container">
  <div class="stat-box blue">
    <h3>Total Vendidos</h3>
    <div class="value" id="totalVendidos">0</div>
  </div>
  <div class="stat-box green">
    <h3>Venta Bea Total</h3>
    <div class="value" id="ventaBea">â‚¬0.00</div>
  </div>
  <div class="stat-box orange">
    <h3>Venta Laura Total</h3>
    <div class="value" id="ventaLaura">â‚¬0.00</div>
  </div>
  <div class="stat-box red">
    <h3>Diferencia (L-B)</h3>
    <div class="value" id="diferencia">â‚¬0.00</div>
  </div>
</div>

</div>

<!-- SCRIPTS NECESARIOS -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>

<!-- LIBRERÃA HTML2PDF para exportaciÃ³n a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productosRef = ref(db, "productos");

let productos = [];

onValue(productosRef, (snap) => {
  const productosObj = snap.val() || {};
  productos = Object.entries(productosObj).map(([id, p]) => ({
    id,
    nombre: p.nombre || "Sin nombre",
    vendidos: p.vendidos || 0,
    bea: p.bea || 0,
    laura: p.laura || 0,
    vBea: p.vBea || 0,
    vLaura: p.vLaura || 0
  }));
  
  mostrarEstadisticas();
});

function mostrarEstadisticas() {
  const productosOrdenados = [...productos].sort((a, b) => b.vendidos - a.vendidos);
  
  const tablaBody = document.getElementById('tablaBody');
  tablaBody.innerHTML = '';
  
  let totalVendidos = 0;
  let totalVentaBea = 0;
  let totalVentaLaura = 0;

  productosOrdenados.forEach(p => {
    const diferencia = p.vLaura - p.vBea;
    const margen = p.vBea > 0 ? ((diferencia / p.vBea) * 100).toFixed(1) : '0.0';
    
    totalVendidos += p.vendidos;
    totalVentaBea += p.vBea;
    totalVentaLaura += p.vLaura;

    const fila = document.createElement('tr');
    fila.className = 'fila-estadistica';
    fila.innerHTML = `
      <td style="text-align:left;font-weight:bold">${p.nombre}</td>
      <td>${p.vendidos}</td>
      <td>â‚¬${p.vBea.toFixed(2)}</td>
      <td>â‚¬${p.vLaura.toFixed(2)}</td>
      <td style="color:${diferencia >= 0 ? '#28a745' : '#dc3545'};font-weight:bold">â‚¬${diferencia.toFixed(2)}</td>
      <td style="color:${margen >= 0 ? '#28a745' : '#dc3545'};font-weight:bold">${margen}%</td>
    `;
    tablaBody.appendChild(fila);
  });

  // TOTALES INFERIORES
  const diferenciaTotalGlobal = totalVentaLaura - totalVentaBea;
  const margenGlobal = totalVentaBea > 0 ? ((diferenciaTotalGlobal / totalVentaBea) * 100).toFixed(1) : '0.0';
  
  document.getElementById('totalVendidos').textContent = totalVendidos;
  document.getElementById('ventaBea').textContent = `â‚¬${totalVentaBea.toFixed(2)}`;
  document.getElementById('ventaLaura').textContent = `â‚¬${totalVentaLaura.toFixed(2)}`;
  document.getElementById('diferencia').textContent = `â‚¬${diferenciaTotalGlobal.toFixed(2)}`;
  
  // STATS SUPERIORES
  const statsContainer = document.getElementById('statsContainer');
  statsContainer.innerHTML = `
    <div class="stat-box green">
      <h3>ğŸ“¦ Total Vendidos</h3>
      <div class="value">${totalVendidos}</div>
    </div>
    <div class="stat-box blue">
      <h3>ğŸ’° Venta Bea</h3>
      <div class="value">â‚¬${totalVentaBea.toFixed(2)}</div>
    </div>
    <div class="stat-box orange">
      <h3>ğŸ’° Venta Laura</h3>
      <div class="value">â‚¬${totalVentaLaura.toFixed(2)}</div>
    </div>
    <div class="stat-box ${diferenciaTotalGlobal >= 0 ? 'green' : 'red'}">
      <h3>ğŸ“Š Diferencia (L-B)</h3>
      <div class="value">â‚¬${diferenciaTotalGlobal.toFixed(2)}</div>
    </div>
    <div class="stat-box blue">
      <h3>ğŸ’¹ Margen Global</h3>
      <div class="value">${margenGlobal}%</div>
    </div>
  `;
}

window.filtrarTabla = () => {
  const termino = document.getElementById('searchInput').value.toLowerCase();
  const filas = document.querySelectorAll('.fila-estadistica');
  
  filas.forEach(fila => {
    const producto = fila.cells[0].textContent.toLowerCase();
    fila.style.display = producto.includes(termino) ? '' : 'none';
  });
};

window.reordenarTabla = () => {
  const orden = document.getElementById('ordenarSelect').value;
  const [campo, dir] = orden.split('-');
  
  let productosOrdenados = [...productos];
  
  productosOrdenados.sort((a, b) => {
    let valorA = a[campo];
    let valorB = b[campo];
    
    if (campo === 'nombre') {
      valorA = (a.nombre || '').toLowerCase();
      valorB = (b.nombre || '').toLowerCase();
      return dir === 'asc' ? valorA.localeCompare(valorB) : valorB.localeCompare(valorA);
    }
    
    return dir === 'asc' ? valorA - valorB : valorB - valorA;
  });
  
  const tablaBody = document.getElementById('tablaBody');
  tablaBody.innerHTML = '';
  
  productosOrdenados.forEach(p => {
    const diferencia = p.vLaura - p.vBea;
    const margen = p.vBea > 0 ? ((diferencia / p.vBea) * 100).toFixed(1) : '0.0';
    
    const fila = document.createElement('tr');
    fila.className = 'fila-estadistica';
    fila.innerHTML = `
      <td style="text-align:left;font-weight:bold">${p.nombre}</td>
      <td>${p.vendidos}</td>
      <td>â‚¬${p.vBea.toFixed(2)}</td>
      <td>â‚¬${p.vLaura.toFixed(2)}</td>
      <td style="color:${diferencia >= 0 ? '#28a745' : '#dc3545'};font-weight:bold">â‚¬${diferencia.toFixed(2)}</td>
      <td style="color:${margen >= 0 ? '#28a745' : '#dc3545'};font-weight:bold">${margen}%</td>
    `;
    tablaBody.appendChild(fila);
  });
};

// ğŸ“¥ EXPORTAR A PDF
window.exportarPDF = () => {
  const element = document.querySelector('.card');
  const opt = {
    margin: 10,
    filename: `estadisticas-inventario-${new Date().toISOString().slice(0, 10)}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' }
  };
  
  html2pdf().set(opt).from(element).save();
  alert('âœ… PDF descargado correctamente');
};

// ğŸ–¨ï¸ IMPRIMIR DIRECTAMENTE
window.imprimirPagina = () => {
  window.print();
};

// â—€ï¸ VOLVER AL INVENTARIO
window.volverInventario = () => {
  window.location.href = 'index.html';
};
</script>

</body>
</html>
