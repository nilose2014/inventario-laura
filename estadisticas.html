<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üìä Estad√≠sticas Inventario Laura - Hist√≥rico</title>

<style>
body{font-family:Arial;background:#f0f2f5;padding:20px;max-width:1200px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
th{background:linear-gradient(45deg,#28a745,#20c997);color:white}
tr:nth-child(even){background:#f8f9fa}
tr:hover{background:#e3f2fd}
.pos1{background:#d4edda !important;font-weight:bold}
.pos2{background:#fff3cd !important;font-weight:bold}
.pos3{background:#cce7ff !important;font-weight:bold}
h2{margin-top:0}
button{padding:6px 10px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:12px;font-weight:bold;margin-left:5px}
button:hover{background:#0056b3}
.admin{background:#d4edda;color:#155724;border:2px solid #c3e6cb;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-weight:bold}
.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-weight:bold}
.tabla-container{overflow:auto}

@media print {
  body{background:white;padding:0;margin:0}
  button, #status, h2 {display:none !important}
  .card{box-shadow:none;padding:0}
  .tabla-container{overflow:visible}
}
</style>
</head>

<body>

<h2>üìä Estad√≠sticas de Productos Vendidos (Hist√≥rico Completo)</h2>

<div id="status" class="admin">Cargando...</div>

<div class="card" id="cardEstadisticas">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <div>
      <strong>Total productos vendidos:</strong>
      <span id="totalProductosVendidos" style="color:#28a745;font-weight:bold">0</span><br>

      <strong>Total unidades vendidas:</strong>
      <span id="totalUnidadesVendidas" style="color:#007bff;font-weight:bold">0</span><br>

      <strong>Total unidades a la venta:</strong>
      <span id="totalUnidadesVenta" style="color:#dc3545;font-weight:bold">0</span><br>

      <strong>Total Bea ‚Ç¨:</strong>
      <span id="totalBea" style="color:#28a745;font-weight:bold">‚Ç¨0.00</span><br>

      <strong>Total Laura ‚Ç¨:</strong>
      <span id="totalLaura" style="color:#007bff;font-weight:bold">‚Ç¨0.00</span>
    </div>

    <div>
      <button onclick="imprimir()">üñ®Ô∏è Imprimir</button>
      <button onclick="descargarPDF()">‚¨áÔ∏è Descargar PDF</button>
      <button onclick="volver()">‚¨ÖÔ∏è Volver</button>
    </div>
  </div>

  <div class="tabla-container">
    <table>
      <thead>
        <tr>
          <th>Pos</th>
          <th>Producto</th>
          <th>Vendidos</th>
          <th>Bea ‚Ç¨</th>
          <th>Laura ‚Ç¨</th>
          <th>% del total</th>
        </tr>
      </thead>
      <tbody id="tablaEstadisticas"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const productosRef = ref(db, "productos");

let productos = {};

onAuthStateChanged(auth, (user) => {
  const status = document.getElementById("status");

  if (!user || user.email !== "nilose2014@gmail.com") {
    status.className = "error";
    status.textContent = "‚ùå Acceso solo para ADMIN";
    setTimeout(() => location.href = "index.html", 2000);
    return;
  }

  status.className = "admin";
  status.textContent = "üëë ADMIN conectado - Estad√≠sticas cargadas";
  cargarEstadisticas();
});

function cargarEstadisticas() {
  onValue(productosRef, snap => {
    productos = snap.val() || {};
    mostrarEstadisticas();
  });
}

function mostrarEstadisticas() {
  const tabla = document.getElementById("tablaEstadisticas");

  const totalProductosVendidosEl = document.getElementById("totalProductosVendidos");
  const totalUnidadesVendidasEl = document.getElementById("totalUnidadesVendidas");
  const totalUnidadesVentaEl = document.getElementById("totalUnidadesVenta");
  const totalBeaEl = document.getElementById("totalBea");
  const totalLauraEl = document.getElementById("totalLaura");

  const lista = Object.entries(productos);

  const totalUnidadesVenta = lista.reduce((acc, [,p]) => acc + Number(p.stock || 0), 0);
  totalUnidadesVentaEl.textContent = totalUnidadesVenta;

  const vendidosProductos = lista
    .filter(([,p]) => Number(p.vendidosTotal || 0) > 0)
    .sort(([,a],[,b]) => Number(b.vendidosTotal || 0) - Number(a.vendidosTotal || 0));

  const totalVendidosGlobal = vendidosProductos.reduce(
    (acc, [,p]) => acc + Number(p.vendidosTotal || 0), 0
  );

  let totalBea = 0;
  let totalLaura = 0;

  totalProductosVendidosEl.textContent = vendidosProductos.length;
  totalUnidadesVendidasEl.textContent = totalVendidosGlobal;

  if (vendidosProductos.length === 0) {
    tabla.innerHTML = `<tr><td colspan="6">‚ùå No hay ventas</td></tr>`;
    return;
  }

  tabla.innerHTML = vendidosProductos.map(([id,p], i) => {
    const vendidos = Number(p.vendidosTotal || 0);
    const bea = Number(p.vBea || 0);
    const laura = Number(p.vLaura || 0);

    totalBea += bea;
    totalLaura += laura;

    const porcentaje = ((vendidos / totalVendidosGlobal) * 100).toFixed(1);

    const clase = i === 0 ? "pos1" : i === 1 ? "pos2" : i === 2 ? "pos3" : "";

    return `
      <tr class="${clase}">
        <td>${i+1}</td>
        <td style="text-align:left;font-weight:bold">${p.nombre}</td>
        <td style="font-size:18px;font-weight:bold;color:#28a745">${vendidos}</td>
        <td style="font-weight:bold;color:#28a745">‚Ç¨${bea.toFixed(2)}</td>
        <td style="font-weight:bold;color:#007bff">‚Ç¨${laura.toFixed(2)}</td>
        <td style="font-weight:bold;color:#ffc107">${porcentaje}%</td>
      </tr>
    `;
  }).join("");

  totalBeaEl.textContent = "‚Ç¨" + totalBea.toFixed(2);
  totalLauraEl.textContent = "‚Ç¨" + totalLaura.toFixed(2);
}

window.volver = () => location.href = "index.html";
window.imprimir = () => window.print();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>

