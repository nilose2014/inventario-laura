<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üìä Estad√≠sticas Inventario Laura - Todos Vendidos</title>
<style>
body{font-family:Arial;background:#f0f2f5;padding:20px;max-width:1200px;margin:0 auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
th{background:linear-gradient(45deg,#28a745,#20c997);color:white}
tr:nth-child(even){background:#f8f9fa}
tr:hover{background:#e3f2fd}
.pos1{background:#d4edda !important;font-weight:bold}
.pos2{background:#fff3cd !important;font-weight:bold}
.pos3{background:#cce7ff !important;font-weight:bold}
h2{margin-top:0}
button{padding:6px 10px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;font-size:12px;font-weight:bold;margin-left:5px}
button:hover{background:#0056b3}
.admin{background:#d4edda;color:#155724;border:2px solid #c3e6cb;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-weight:bold}
.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-weight:bold}

/* Opcional: ocultar botones y fondo en impresi√≥n */
@media print {
  body{background:white;padding:0;margin:0}
  button, #status {display:none !important}
}
</style>
</head>
<body>

<h2>üìä Estad√≠sticas de Productos Vendidos (Hist√≥rico Completo)</h2>

<div id="status" class="admin">Cargando...</div>

<div class="card" id="cardEstadisticas">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <div>
      <strong>Total productos con ventas:</strong> <span id="totalProductosVendidos" style="color:#28a745;font-weight:bold">0</span><br>
      <strong>Total unidades vendidas:</strong> <span id="totalUnidadesVendidas" style="color:#007bff;font-weight:bold">0</span>
    </div>
    <div>
      <button onclick="imprimir()">üñ®Ô∏è Imprimir</button>
      <button onclick="descargarPDF()">‚¨áÔ∏è Descargar PDF</button>
      <button onclick="volver()">‚¨ÖÔ∏è Volver al Inventario</button>
    </div>
  </div>
  <div style="overflow:auto;max-height:500px">
    <table>
      <thead>
        <tr>
          <th>Pos</th>
          <th>Producto</th>
          <th>Vendidos</th>
          <th>Bea ‚Ç¨</th>
          <th>Laura ‚Ç¨</th>
          <th>% Vendidos</th>
        </tr>
      </thead>
      <tbody id="tablaEstadisticas"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
  authDomain: "inventario-laura.firebaseapp.com",
  databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "inventario-laura",
  storageBucket: "inventario-laura.firebasestorage.app",
  messagingSenderId: "778807935660",
  appId: "1:778807935660:web:947e223465f9347b17d509"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const productosRef = ref(db, "productos");

let productos = {};

onAuthStateChanged(auth, (user) => {
  const status = document.getElementById('status');
  if (!user) {
    status.className = 'error';
    status.textContent = '‚ùå Debes iniciar sesi√≥n como ADMIN para ver las estad√≠sticas.';
    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
    return;
  }
  if (user.email !== 'nilose2014@gmail.com') {
    status.className = 'error';
    status.textContent = '‚ùå Solo el ADMIN (nilose2014@gmail.com) puede ver esta p√°gina.';
    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
    return;
  }
  status.className = 'admin';
  status.textContent = `üëë ADMIN: ${user.email} - Estad√≠sticas completas cargadas ‚úÖ`;
  cargarEstadisticas();
});

function cargarEstadisticas() {
  onValue(productosRef, (snap) => {
    productos = snap.val() || {};
    mostrarEstadisticasCompletas();
  }, (error) => {
    const status = document.getElementById('status');
    status.className = 'error';
    status.textContent = '‚ùå Error cargando datos: ' + error.message;
  });
}

function mostrarEstadisticasCompletas() {
  const tablaEstadisticas = document.getElementById('tablaEstadisticas');
  const totalProductosVendidosEl = document.getElementById('totalProductosVendidos');
  const totalUnidadesVendidasEl = document.getElementById('totalUnidadesVendidas');

  const todosConVentas = Object.entries(productos)
    .filter(([id,p]) => Number(p.vendidos || 0) > 0)
    .sort(([,a], [,b]) => Number(b.vendidos || 0) - Number(a.vendidos || 0));

  const totalVendidosGlobal = todosConVentas.reduce((acc, [,p]) => acc + Number(p.vendidos || 0), 0);

  if (todosConVentas.length === 0) {
    tablaEstadisticas.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999">‚ùå No hay ventas registradas a√∫n</td></tr>';
    totalProductosVendidosEl.textContent = '0';
    totalUnidadesVendidasEl.textContent = '0';
    return;
  }

  totalProductosVendidosEl.textContent = String(todosConVentas.length);
  totalUnidadesVendidasEl.textContent = String(totalVendidosGlobal);

  tablaEstadisticas.innerHTML = todosConVentas.map(([id,p], index) => {
    const vendidos = Number(p.vendidos || 0);
    const beaTotal = Number(p.vBea || vendidos * (p.bea || 0) || 0).toFixed(2);
    const lauraTotal = Number(p.vLaura || vendidos * (p.laura || 0) || 0).toFixed(2);
    const porcentaje = totalVendidosGlobal > 0 ? ((vendidos / totalVendidosGlobal) * 100).toFixed(1) : 0;

    let clasePos = '';
    if(index === 0) clasePos = 'pos1';
    else if(index === 1) clasePos = 'pos2';
    else if(index === 2) clasePos = 'pos3';

    return `
      <tr class="${clasePos}">
        <td style="font-weight:bold;font-size:16px">${index+1}</td>
        <td style="text-align:left;font-weight:bold">
          <a href="index.html?editId=${encodeURIComponent(id)}" style="color:#007bff;text-decoration:underline;cursor:pointer">
            ${p.nombre}
          </a>
        </td>
        <td style="font-size:18px;color:#28a745;font-weight:bold">${vendidos}</td>
        <td style="color:#28a745;font-weight:bold">‚Ç¨${beaTotal}</td>
        <td style="color:#007bff;font-weight:bold">‚Ç¨${lauraTotal}</td>
        <td style="color:#ffc107;font-weight:bold">${porcentaje}%</td>
      </tr>
    `;
  }).join('');
}

// --------- BOTONES EXTRA ---------
window.volver = () => {
  window.location.href = 'index.html';
};

window.imprimir = () => {
  window.print(); // imprime la p√°gina con estilos actuales
};

window.descargarPDF = async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');

  const element = document.getElementById('cardEstadisticas');

  const canvas = await html2canvas(element, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');

  const pdfWidth = doc.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

  doc.addImage(imgData, 'PNG', 0, 20, pdfWidth, pdfHeight);
  doc.save('estadisticas-inventario-laura.pdf');
};
</script>

<!-- Librer√≠as para generar PDF desde HTML (jsPDF + html2canvas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</body>
</html>
