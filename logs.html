<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>LOGS - Inventario Laura</title>
    <style>
        body { font-family: Arial; background: #f0f2f5; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .login-card { background: #fff3cd; border: 2px solid #ffeaa7; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .log-table th, .log-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        .log-table th { background: #dc3545; color: white; font-size: 12px; }
        .log-table tr:nth-child(even) { background: #f8f9fa; }
        .log-venta { background: #d4edda !important; }
        .log-reserva { background: #e8f4fd !important; }
        .log-cancelacion { background: #fff3cd !important; }
        .log-eliminacion { background: #f8d7da !important; }
        .log-tipico { background: #e2e3e5 !important; }
        .log-tipo { font-weight: bold; font-size: 11px; padding: 2px 6px; border-radius: 3px; margin: 1px; display: inline-block; }
        .tipo-venta { background: #28a745 !important; color: white !important; }
        .tipo-reserva { background: #17a2b8 !important; color: white !important; }
        .tipo-cancel-reserva { background: #ffc107 !important; color: black !important; }
        .tipo-elim-venta { background: #dc3545 !important; color: white !important; }
        .tipo-backup { background: #6f42c1 !important; color: white !important; }
        .tipo-stock { background: #20c997 !important; color: white !important; }
        .tipo-precio { background: #007bff !important; color: white !important; }
        .tipo-reset { background: #343a40 !important; color: white !important; }
        .filtros-logs { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        #logFechaDesde, #logFechaHasta { width: 140px; padding: 6px; border: 1px solid #ddd; border-radius: 5px; }
        #logBuscar { width: 200px; padding: 8px; }
        #logTipo { padding: 6px; border-radius: 5px; border: 1px solid #ddd; }
        button { padding: 8px 15px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; font-weight: bold; margin: 2px; }
        button:hover { background: #0056b3; }
        .red { background: #dc3545; color: white; }
        .clean-logs { background: #dc3545 !important; font-size: 14px !important; padding: 12px 20px !important; }
        .clean-logs:hover { background: #c82333 !important; }
        .debug-btn { background: #6f42c1 !important; }
        .debug-btn:hover { background: #5a32a3 !important; }
        .totales-logs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; font-size: 18px; font-weight: bold; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 10px; }
        .total-bea-total { background: #d4edda; color: #155724; border: 2px solid #28a745; padding: 10px; border-radius: 8px; }
        .total-cant { background: #cce7ff; color: #004085; border: 2px solid #007bff; padding: 10px; border-radius: 8px; }
        #logCount { background: #007bff; color: white; padding: 8px 12px; border-radius: 5px; font-weight: bold; display: inline-block; }
        #status { padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 16px; }
        .admin { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .hiden { display: none; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="card login-card" id="loginDiv">
        <h3>Iniciar SesiÃ³n</h3>
        <input id="userEmail" type="email" placeholder="Email" list="userList"><br>
        <input id="userPass" type="password" placeholder="ContraseÃ±a"><br><br>
        <datalist id="userList">
            <option value="nilose2014@gmail.com">ADMIN</option>
        </datalist>
        <button onclick="login()">Entrar</button>
        <button class="red" onclick="resetLogin()">Limpiar</button>
    </div>

    <!-- APP -->
    <div id="mainApp" class="hiden">
        <div id="status">Cargando...</div>
        <div class="card">
            <h2>HISTORIAL COMPLETO DE MOVIMIENTOS</h2>
            <div class="filtros-logs">
                <input id="logBuscar" placeholder="Buscar producto/usuario..." onkeyup="aplicarFiltros()">
                <input type="date" id="logFechaDesde" onchange="cargarLogs()">
                <input type="date" id="logFechaHasta" onchange="cargarLogs()">
                <select id="logTipo" onchange="aplicarFiltros()" title="Filtrar por tipo de movimiento">
                    <option value="todos">Todos los tipos</option>
                    <option value="venta">Solo VENTAS</option>
                    <option value="reserva">Solo RESERVAS</option>
                    <option value="cancelacion-reserva">Solo CANCEL. RESERVA</option>
                    <option value="eliminacion-venta">Solo ELIMINACIÃ“N VENTA</option>
                    <option value="backup-creado">Backups creados</option>
                    <option value="backup-restaurado">Backups restaurados</option>
                    <option value="stock-anadido">Stock aÃ±adido</option>
                    <option value="stock-modificado">Stock modificado</option>
                    <option value="proximo-modificado">PrÃ³ximo modificado</option>
                    <option value="precio-laura">Precio Laura</option>
                    <option value="precio-laura-global">Precio Laura GLOBAL</option>
                    <option value="producto-creado">Producto creado</option>
                    <option value="producto-editado">Producto editado</option>
                    <option value="producto-borrado">Producto borrado</option>
                    <option value="reset-completo">Reset COMPLETO</option>
                </select>
                <button onclick="cargarLogs()">Recargar</button>
                <button class="debug-btn" onclick="irDebug()" title="Abrir pÃ¡gina de depuraciÃ³n">ðŸ”§ DEBUG</button>
                <button class="clean-logs" onclick="limpiarTodosLogs()" title="âš ï¸ BORRA TODOS los logs permanentemente">LIMPIAR TODOS LOGS</button>
                <div style="flex: 1;"></div>
                <button class="red" onclick="logout()">Cerrar SesiÃ³n</button>
            </div>

            <!-- â­ TOTAL BEA del INDEX (TODOS los productos) -->
            <div class="totales-logs">
                <div class="total-bea-total">
                    <strong>ðŸ’° TOTAL BEA INDEX</strong><br>
                    <span id="totalBeaIndex" style="font-size: 24px; color: #28a745;">0.00 â‚¬</span>
                </div>
                <div class="total-cant">
                    <strong>ðŸ“¦ TOTAL CANTIDAD (filtrados)</strong><br>
                    <span id="totalCantidadLogs" style="font-size: 24px; color: #007bff;">0</span>
                </div>
            </div>

            <div id="logCount"></div>
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Fecha</th><th>Tipo</th><th>Producto</th><th>Cant.</th><th>Usuario</th><th>Detalles</th>
                    </tr>
                </thead>
                <tbody id="tablaLogs"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBYKEUjEi8TDwJ79l1QU67BNAPn7QOsKV4",
            authDomain: "inventario-laura.firebaseapp.com",
            databaseURL: "https://inventario-laura-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "inventario-laura",
            storageBucket: "inventario-laura.firebasestorage.app",
            messagingSenderId: "778807935660",
            appId: "1778807935660web947e223465f9347b17d509"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const logsRef = ref(db, 'logs');
        const productosRef = ref(db, 'productos'); // â­ PARA TOTAL BEA INDEX
        let todosLogs = [];
        let todosProductos = {};
        let currentUser = null;

        window.login = () => {
            const email = document.getElementById('userEmail').value.trim();
            const pass = document.getElementById('userPass').value;
            if (!email || !pass) return alert('Email y contraseÃ±a requeridos');
            signInWithEmailAndPassword(auth, email, pass).catch(e => alert('Error: ' + e.message));
        };

        window.logout = () => {
            signOut(auth).catch(e => alert('Error: ' + e.message));
        };

        window.resetLogin = () => {
            document.getElementById('userEmail').value = '';
            document.getElementById('userPass').value = '';
        };

        window.irDebug = () => {
            window.open('https://nilose2014.github.io/inventario-laura/debug.html', '_blank');
        };

        window.limpiarTodosLogs = async () => {
            if (!confirm('âš ï¸ Â¿BORRAR TODOS los logs permanentemente?\n\nEsta acciÃ³n NO se puede deshacer.')) return;
            try {
                await remove(logsRef);
                alert('âœ… TODOS los logs han sido eliminados');
                todosLogs = [];
                renderLogsFiltrados([]);
            } catch (error) {
                alert('âŒ Error al limpiar logs: ' + error.message);
            }
        };

        // â­ CALCULAR TOTAL BEA del INDEX (suma bea de TODOS los productos)
        window.calcularTotalBeaIndex = () => {
            let totalBea = 0;
            Object.values(todosProductos).forEach(producto => {
                totalBea += Number(producto.bea || 0);
            });
            document.getElementById('totalBeaIndex').textContent = totalBea.toFixed(2) + ' â‚¬';
        };

        // Calcular totales de logs filtrados (solo cantidad)
        window.calcularTotalesLogs = (logs) => {
            let totalCantidad = 0;
            logs.forEach(log => {
                if (log.cantidad) {
                    totalCantidad += Number(log.cantidad);
                }
            });
            document.getElementById('totalCantidadLogs').textContent = totalCantidad.toLocaleString();
        };

        // Cargar PRODUCTOS para total Bea Index
        onValue(productosRef, (snap) => {
            todosProductos = snap.val() || {};
            calcularTotalBeaIndex();
        });

        window.cargarLogs = () => {
            const desde = document.getElementById('logFechaDesde').value;
            const hasta = document.getElementById('logFechaHasta').value;
            
            onValue(logsRef, (snap) => {
                todosLogs = [];
                snap.forEach((child) => {
                    const log = child.val();
                    const fecha = new Date(log.timestamp);
                    const fechaStr = fecha.toISOString().split('T')[0];
                    if ((desde === '' || fechaStr >= desde) && (hasta === '' || fechaStr <= hasta)) {
                        todosLogs.push({...log, key: child.key});
                    }
                });
                todosLogs.sort((a,b) => b.timestamp - a.timestamp);
                aplicarFiltros();
            });
        };

        window.aplicarFiltros = () => {
            const filtroTexto = document.getElementById('logBuscar').value.toLowerCase();
            const tipoSeleccionado = document.getElementById('logTipo').value;

            const filtrados = todosLogs.filter(log => {
                const coincideTexto =
                    log.productoNombre.toLowerCase().includes(filtroTexto) ||
                    log.usuario.toLowerCase().includes(filtroTexto) ||
                    (log.detalles || '').toLowerCase().includes(filtroTexto);

                const coincideTipo =
                    tipoSeleccionado === 'todos' ||
                    log.tipo === tipoSeleccionado;

                return coincideTexto && coincideTipo;
            });

            renderLogsFiltrados(filtrados);
        };

        window.renderLogsFiltrados = (logs) => {
            const tabla = document.getElementById('tablaLogs');
            tabla.innerHTML = '';
            
            // Calcular totales de logs filtrados
            calcularTotalesLogs(logs);

            logs.forEach(log => {
                let claseTipo = '';
                let claseFila = '';

                switch (log.tipo) {
                    case 'venta':
                        claseTipo = 'tipo-venta'; claseFila = 'log-venta'; break;
                    case 'reserva':
                        claseTipo = 'tipo-reserva'; claseFila = 'log-reserva'; break;
                    case 'cancelacion-reserva':
                        claseTipo = 'tipo-cancel-reserva'; claseFila = 'log-cancelacion'; break;
                    case 'eliminacion-venta':
                        claseTipo = 'tipo-elim-venta'; claseFila = 'log-eliminacion'; break;
                    case 'backup-creado':
                    case 'backup-restaurado':
                        claseTipo = 'tipo-backup'; claseFila = 'log-tipico'; break;
                    case 'stock-anadido':
                    case 'stock-modificado':
                    case 'proximo-modificado':
                        claseTipo = 'tipo-stock'; claseFila = 'log-tipico'; break;
                    case 'precio-laura':
                    case 'precio-laura-global':
                        claseTipo = 'tipo-precio'; claseFila = 'log-tipico'; break;
                    case 'producto-creado':
                    case 'producto-editado':
                    case 'producto-borrado':
                        claseTipo = 'tipo-precio'; claseFila = 'log-tipico'; break;
                    case 'reset-completo':
                        claseTipo = 'tipo-reset'; claseFila = 'log-tipico'; break;
                    default:
                        claseTipo = ''; claseFila = ''; break;
                }

                tabla.innerHTML += `
                    <tr class="${claseFila}">
                        <td>${log.fecha}</td>
                        <td><span class="log-tipo ${claseTipo}">${log.tipo.replace(/-/g, ' ').toUpperCase()}</span></td>
                        <td style="text-align:left">${log.productoNombre || ''}</td>
                        <td>${log.cantidad}</td>
                        <td>${log.usuario}</td>
                        <td style="text-align:left;font-size:11px">${log.detalles || ''}</td>
                    </tr>
                `;
            });
            document.getElementById('logCount').textContent = `${logs.length} movimientos encontrados`;
        };

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'nilose2014@gmail.com') {
                currentUser = user;
                document.getElementById('loginDiv').classList.add('hiden');
                document.getElementById('mainApp').classList.remove('hiden');
                document.getElementById('status').innerHTML = `<strong>ADMIN</strong> ${user.email}<br>Logs cargando...`;
                document.getElementById('status').className = 'admin';
                cargarLogs();
            } else {
                document.getElementById('mainApp').classList.add('hiden');
                document.getElementById('loginDiv').classList.remove('hiden');
                document.getElementById('status').innerHTML = 'SesiÃ³n requerida';
            }
        });

        window.onload = () => {
            const hoy = new Date().toISOString().split('T')[0];
            const hace7dias = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
            document.getElementById('logFechaDesde').value = hace7dias;
            document.getElementById('logFechaHasta').value = hoy;
        };
    </script>
</body>
</html>
